---
phase: 16-complementary-validations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/core/extraction/schemas.py
  - app/core/extraction/prompts/complementary.py
  - app/core/extraction/ocr.py
  - app/core/extraction/__init__.py
autonomous: true

must_haves:
  truths:
    - "OCR can extract serial number from calibration certificate photo"
    - "OCR can extract temperature reading from thermo-hygrometer photo"
    - "OCR results include confidence scores for low-confidence flagging"
  artifacts:
    - path: "app/core/extraction/prompts/complementary.py"
      provides: "OCR prompts for certificate serial and hygrometer reading"
      exports: ["CERTIFICATE_OCR_PROMPT", "HYGROMETER_OCR_PROMPT"]
    - path: "app/core/extraction/ocr.py"
      provides: "OCR extraction functions using Claude Vision"
      exports: ["extract_certificate_serial", "extract_hygrometer_reading", "CertificateOCRResult", "HygrometerOCRResult"]
    - path: "app/core/extraction/schemas.py"
      provides: "Extended schemas for OCR results"
      contains: "CertificateOCRResult"
  key_links:
    - from: "app/core/extraction/ocr.py"
      to: "app/core/extraction/client.py"
      via: "extract_structured function"
      pattern: "from app.core.extraction.client import extract_structured"
---

<objective>
Create OCR extraction infrastructure for complementary validations.

Purpose: SERIAL_MISMATCH and VALUE_MISMATCH validators need data extracted from photos (calibration certificate serial, thermo-hygrometer temperature). This extraction must happen BEFORE validation to maintain validator determinism. Claude Vision OCR with structured output provides this capability.

Output: Reusable OCR extraction module with schemas, prompts, and async functions for certificate serial and hygrometer reading extraction.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/16-complementary-validations/16-CONTEXT.md
@.planning/phases/16-complementary-validations/16-RESEARCH.md

# Existing extraction patterns
@app/core/extraction/client.py
@app/core/extraction/thermography.py
@app/core/extraction/schemas.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create OCR prompts for certificate and hygrometer</name>
  <files>app/core/extraction/prompts/complementary.py</files>
  <action>
Create prompts module for OCR extraction with two prompts:

1. `CERTIFICATE_OCR_PROMPT` - Extract serial number from calibration certificate photo:
   - Look for "Serial No:", "S/N:", "Serial Number:", "Numero de Serie:"
   - Extract the camera/device serial number (alphanumeric)
   - Include calibration lab name if visible
   - Return confidence based on legibility (clear text = 0.95, partially obscured = 0.7, hard to read = 0.5)

2. `HYGROMETER_OCR_PROMPT` - Extract temperature reading from thermo-hygrometer photo:
   - Look for digital display showing temperature (C or F)
   - Extract ambient temperature reading
   - Extract humidity reading if visible
   - Return confidence based on display clarity

Prompts should be specific about what to look for and how to assess confidence. Follow the style of existing prompts in `app/core/extraction/prompts/`.

Create the prompts/ directory if it does not exist.
  </action>
  <verify>File exists at app/core/extraction/prompts/complementary.py with both prompt constants defined</verify>
  <done>Both CERTIFICATE_OCR_PROMPT and HYGROMETER_OCR_PROMPT are defined with clear extraction instructions</done>
</task>

<task type="auto">
  <name>Task 2: Create OCR result schemas and extraction functions</name>
  <files>app/core/extraction/ocr.py, app/core/extraction/__init__.py</files>
  <action>
Create OCR extraction module with Pydantic schemas and async extraction functions:

**Schemas (in ocr.py):**

```python
class CertificateOCRResult(BaseModel):
    """OCR result from calibration certificate photo."""
    serial_number: FieldConfidence  # Camera/device serial number
    calibration_lab: FieldConfidence | None = None  # Lab name if visible
    calibration_date: FieldConfidence | None = None  # Date if visible

class HygrometerOCRResult(BaseModel):
    """OCR result from thermo-hygrometer display photo."""
    ambient_temperature: FieldConfidence  # Temperature in Celsius
    humidity: FieldConfidence | None = None  # Relative humidity %
```

**Functions:**

```python
async def extract_certificate_serial(image: bytes) -> tuple[CertificateOCRResult, ExtractionMetadata]:
    """Extract serial number from calibration certificate image."""
    # Use extract_structured with CERTIFICATE_OCR_PROMPT
    # Convert bytes to base64
    # Return structured result with metadata

async def extract_hygrometer_reading(image: bytes) -> tuple[HygrometerOCRResult, ExtractionMetadata]:
    """Extract temperature from thermo-hygrometer display image."""
    # Use extract_structured with HYGROMETER_OCR_PROMPT
```

Follow the pattern from `app/core/extraction/client.py` for base64 encoding and calling `extract_structured`.

Export new classes from `app/core/extraction/__init__.py`.
  </action>
  <verify>
```bash
cd /home/xande && python -c "from app.core.extraction.ocr import extract_certificate_serial, extract_hygrometer_reading, CertificateOCRResult, HygrometerOCRResult; print('OCR module imports OK')"
```
  </verify>
  <done>OCR module with schemas and async functions exists and imports correctly. Functions use extract_structured client with appropriate prompts.</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for OCR schemas</name>
  <files>app/tests/extraction/test_ocr.py</files>
  <action>
Create unit tests for OCR schemas (not async extraction - that requires API):

```python
# app/tests/extraction/test_ocr.py
import pytest
from app.core.extraction.ocr import CertificateOCRResult, HygrometerOCRResult
from app.core.extraction.schemas import FieldConfidence

class TestCertificateOCRResult:
    def test_valid_result(self):
        """Test creating valid certificate OCR result."""
        result = CertificateOCRResult(
            serial_number=FieldConfidence(value="ABC123456", confidence=0.95),
            calibration_lab=FieldConfidence(value="FLUKE", confidence=0.9),
        )
        assert result.serial_number.value == "ABC123456"
        assert result.serial_number.confidence == 0.95

    def test_minimal_result(self):
        """Test with only required fields."""
        result = CertificateOCRResult(
            serial_number=FieldConfidence(value="XYZ789", confidence=0.7),
        )
        assert result.calibration_lab is None

class TestHygrometerOCRResult:
    def test_valid_result(self):
        """Test creating valid hygrometer OCR result."""
        result = HygrometerOCRResult(
            ambient_temperature=FieldConfidence(value=23.5, confidence=0.95),
            humidity=FieldConfidence(value=45.0, confidence=0.9),
        )
        assert result.ambient_temperature.value == 23.5

    def test_temp_only(self):
        """Test with only temperature (humidity not visible)."""
        result = HygrometerOCRResult(
            ambient_temperature=FieldConfidence(value=25.0, confidence=0.8),
        )
        assert result.humidity is None
```

Create the extraction/ test directory if it does not exist.
  </action>
  <verify>
```bash
cd /home/xande && python -m pytest app/tests/extraction/test_ocr.py -v
```
  </verify>
  <done>All OCR schema tests pass</done>
</task>

</tasks>

<verification>
```bash
# All imports work
cd /home/xande && python -c "
from app.core.extraction.ocr import (
    extract_certificate_serial,
    extract_hygrometer_reading,
    CertificateOCRResult,
    HygrometerOCRResult,
)
from app.core.extraction.prompts.complementary import (
    CERTIFICATE_OCR_PROMPT,
    HYGROMETER_OCR_PROMPT,
)
print('All OCR exports OK')
"

# Tests pass
cd /home/xande && python -m pytest app/tests/extraction/test_ocr.py -v
```
</verification>

<success_criteria>
- OCR prompts defined with clear instructions for serial and temperature extraction
- Pydantic schemas for OCR results with FieldConfidence pattern
- Async extraction functions using existing extract_structured client
- Unit tests for schemas pass
- All new code follows existing codebase patterns
</success_criteria>

<output>
After completion, create `.planning/phases/16-complementary-validations/16-01-SUMMARY.md`
</output>
