---
phase: 05-api-findings
plan: 04
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - app/core/middleware.py
  - app/main.py
autonomous: true

must_haves:
  truths:
    - "API rate limits to 10 requests/minute per user"
    - "Rate limit exceeded returns 429 Too Many Requests"
    - "OpenAPI documentation available at /docs"
    - "API responses follow consistent JSON structure"
  artifacts:
    - path: "app/core/middleware.py"
      provides: "Rate limiting middleware"
      exports: ["RateLimitMiddleware", "rate_limit_dependency"]
  key_links:
    - from: "app/main.py"
      to: "app/core/middleware.py"
      via: "add_middleware"
      pattern: "RateLimitMiddleware"
---

<objective>
Implement rate limiting and finalize OpenAPI documentation.

Purpose: Prevent API abuse with rate limiting (API-05) and ensure API documentation (API-07).
Output: Rate limiting middleware, enhanced OpenAPI docs with all endpoints documented.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Auth provides user identification (from 05-01)
@app/core/auth.py

# FastAPI app configuration
@app/main.py
@app/config.py

# Existing middleware patterns
@app/core/exceptions.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create rate limiting middleware</name>
  <files>app/core/middleware.py, app/config.py</files>
  <action>
    Create app/core/middleware.py with rate limiting:

    1. Use Redis for distributed rate limiting:
       - Key format: rate_limit:{user_id or ip}:{minute_bucket}
       - TTL: 60 seconds
       - Increment on each request

    2. RateLimitMiddleware class (Starlette BaseHTTPMiddleware):
       - Extract user_id from JWT token if present, else use client IP
       - Check request count in Redis
       - If count >= limit (10), return 429 response
       - Otherwise increment and proceed
       - Add X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset headers

    3. rate_limit_dependency for per-route limits (alternative pattern):
       - FastAPI dependency that can override default limit
       - Useful for specific endpoints needing different limits

    4. Handle Redis unavailable gracefully:
       - If Redis down, log warning and allow request (fail open)
       - Don't block API when rate limiter is unavailable

    Update app/config.py:
       - Add RATE_LIMIT_PER_MINUTE: int = 10
       - Add RATE_LIMIT_ENABLED: bool = True

    Rate limit response format:
    {
      "error": "rate_limit_exceeded",
      "detail": "Rate limit exceeded. Try again in X seconds.",
      "retry_after": 45
    }
  </action>
  <verify>python -c "from app.core.middleware import RateLimitMiddleware; print('OK')"</verify>
  <done>Rate limiting middleware created with Redis storage</done>
</task>

<task type="auto">
  <name>Task 2: Register middleware and enhance OpenAPI docs</name>
  <files>app/main.py</files>
  <action>
    Update app/main.py:

    1. Add rate limiting middleware:
       - Import RateLimitMiddleware from app.core.middleware
       - Add after CORS middleware: app.add_middleware(RateLimitMiddleware)
       - Only add if settings.RATE_LIMIT_ENABLED

    2. Enhance OpenAPI configuration:
       - Add description with markdown for API overview
       - Add contact info and license
       - Add tags_metadata for grouping endpoints:
         - auth: Authentication endpoints
         - analyses: Document analysis operations
         - validation: Validation rules and standards
         - tasks: Task status tracking
         - health: Health checks

    3. Add API versioning info:
       - openapi_url="/api/v1/openapi.json"
       - docs_url="/docs" (already default)
       - redoc_url="/redoc"

    4. Ensure all routers have proper tags:
       - health_router: tags=["health"]
       - auth_router: tags=["auth"]
       - analyses_router: tags=["analyses"]
       - validation_router: tags=["validation"]
       - tasks_router: tags=["tasks"]
       - upload_router: tags=["upload"] (may be deprecated in favor of analyses)

    OpenAPI description should include:
       - API purpose
       - Authentication requirements
       - Rate limiting policy
       - Error response format
  </action>
  <verify>curl http://localhost:8000/docs -s | head -20</verify>
  <done>Rate limiting active, OpenAPI docs enhanced</done>
</task>

<task type="auto">
  <name>Task 3: Add rate limiting tests</name>
  <files>app/tests/middleware/__init__.py, app/tests/middleware/test_rate_limit.py</files>
  <action>
    Create app/tests/middleware/__init__.py (empty package file)

    Create app/tests/middleware/test_rate_limit.py:

    1. test_rate_limit_allows_under_limit:
       - Make 9 requests
       - All should return 200
       - Check X-RateLimit-Remaining header decrements

    2. test_rate_limit_blocks_over_limit:
       - Make 11 requests in quick succession
       - 11th request should return 429
       - Response includes retry_after

    3. test_rate_limit_resets_after_window:
       - Make 10 requests (hit limit)
       - Mock time forward 60 seconds
       - Next request should succeed

    4. test_rate_limit_per_user:
       - User A makes 10 requests (hits limit)
       - User B can still make requests
       - Demonstrates per-user isolation

    5. test_rate_limit_graceful_redis_failure:
       - Mock Redis to raise exception
       - Request should still succeed (fail open)
       - Warning logged

    Use pytest fixtures:
       - test_client
       - mock_redis for Redis operations
       - auth_headers for authenticated requests
  </action>
  <verify>pytest app/tests/middleware/test_rate_limit.py -v</verify>
  <done>Rate limiting tests pass</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Rate limiting middleware blocks after 10 requests/minute
- [ ] 429 response includes retry_after and proper error format
- [ ] Rate limit headers (X-RateLimit-*) present in responses
- [ ] OpenAPI docs at /docs show all endpoints
- [ ] Redoc docs at /redoc available
- [ ] API description includes auth and rate limit info
- [ ] Rate limiting tests pass
- [ ] Redis failure doesn't break API (graceful degradation)
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Rate limiting protects API per API-05 requirement
- OpenAPI documentation complete per API-07 requirement
</success_criteria>

<output>
After completion, create `.planning/phases/05-api-findings/05-04-SUMMARY.md`
</output>
