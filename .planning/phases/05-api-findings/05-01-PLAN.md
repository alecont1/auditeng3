---
phase: 05-api-findings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/core/auth.py
  - app/api/auth.py
  - app/schemas/auth.py
  - app/api/__init__.py
  - app/main.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "User can register with email and password"
    - "User can login and receive JWT token"
    - "User can access protected endpoints with valid token"
    - "Invalid/expired tokens are rejected with 401"
  artifacts:
    - path: "app/core/auth.py"
      provides: "JWT token generation and verification"
      exports: ["create_access_token", "verify_token", "get_current_user"]
    - path: "app/api/auth.py"
      provides: "Authentication endpoints"
      exports: ["router"]
    - path: "app/schemas/auth.py"
      provides: "Auth request/response schemas"
      exports: ["TokenResponse", "LoginRequest", "RegisterRequest"]
  key_links:
    - from: "app/api/auth.py"
      to: "app/core/auth.py"
      via: "create_access_token in login/register"
      pattern: "create_access_token"
    - from: "app/core/auth.py"
      to: "app/db/models/user.py"
      via: "User lookup in get_current_user"
      pattern: "select.*User"
---

<objective>
Implement JWT authentication for the AuditEng API.

Purpose: Secure API endpoints with JWT-based authentication per API-04 requirement.
Output: Auth endpoints (register, login, me) and get_current_user dependency for protected routes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior work - foundation provides User model and FastAPI app
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/phases/01-foundation/01-05-SUMMARY.md

# Existing code to integrate with
@app/db/models/user.py
@app/core/dependencies.py
@app/core/exceptions.py
@app/main.py
@app/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add python-jose and passlib dependencies</name>
  <files>pyproject.toml</files>
  <action>
    Add to pyproject.toml dependencies:
    - python-jose[cryptography] for JWT encoding/decoding
    - passlib[bcrypt] for password hashing

    Do NOT use PyJWT - use python-jose for better algorithm support.

    Run: uv pip install -e . to install new dependencies.
  </action>
  <verify>python -c "from jose import jwt; from passlib.context import CryptContext; print('OK')"</verify>
  <done>JWT and password hashing libraries installed</done>
</task>

<task type="auto">
  <name>Task 2: Create auth core module with JWT utilities</name>
  <files>app/core/auth.py, app/config.py</files>
  <action>
    Create app/core/auth.py with:

    1. Password hashing using passlib CryptContext with bcrypt:
       - hash_password(password: str) -> str
       - verify_password(plain: str, hashed: str) -> bool

    2. JWT token management:
       - SECRET_KEY from settings (add JWT_SECRET_KEY to config.py, default to random for dev)
       - ACCESS_TOKEN_EXPIRE_MINUTES = 30 (add to config.py)
       - create_access_token(data: dict, expires_delta: timedelta | None = None) -> str
       - verify_token(token: str) -> dict | None (returns payload or None if invalid)

    3. FastAPI dependency for protected routes:
       - get_current_user(token: str = Depends(oauth2_scheme), db: AsyncSession = Depends(get_db)) -> User
       - Use OAuth2PasswordBearer(tokenUrl="/api/auth/login")
       - Raise AuthenticationError if token invalid or user not found

    Update app/config.py:
       - Add JWT_SECRET_KEY: str with default (openssl rand -hex 32 for production)
       - Add ACCESS_TOKEN_EXPIRE_MINUTES: int = 30

    Use jose.jwt.encode/decode with HS256 algorithm.
    Include "sub" claim for user_id and "exp" for expiration.
  </action>
  <verify>python -c "from app.core.auth import hash_password, verify_password, create_access_token; print('OK')"</verify>
  <done>JWT utilities and password hashing work correctly</done>
</task>

<task type="auto">
  <name>Task 3: Create auth schemas and API endpoints</name>
  <files>app/schemas/auth.py, app/api/auth.py, app/main.py</files>
  <action>
    Create app/schemas/auth.py with Pydantic v2 schemas:
    - RegisterRequest: email (EmailStr), password (min_length=8)
    - LoginRequest: email, password (for OAuth2PasswordRequestForm compatibility, use username field)
    - TokenResponse: access_token, token_type="bearer"
    - UserResponse: id, email, is_active, created_at

    Create app/api/auth.py with APIRouter(prefix="/api/auth", tags=["auth"]):

    1. POST /register - Create new user:
       - Validate email not already registered (409 Conflict if exists)
       - Hash password with hash_password()
       - Create User in database
       - Return TokenResponse with new JWT

    2. POST /login - Login with credentials:
       - Use OAuth2PasswordRequestForm for standard OAuth2 flow
       - Find user by email
       - Verify password
       - Return TokenResponse or 401 Unauthorized

    3. GET /me - Get current user (protected):
       - Depends on get_current_user
       - Return UserResponse

    4. POST /refresh - Refresh token (protected):
       - Depends on get_current_user
       - Return new TokenResponse

    Update app/main.py:
       - Import and include auth_router

    All endpoints return structured JSON per existing patterns in app/core/exceptions.py.
  </action>
  <verify>curl -X POST http://localhost:8000/api/auth/register -H "Content-Type: application/json" -d '{"email":"test@test.com","password":"testpass123"}' | grep access_token</verify>
  <done>Auth endpoints work: register returns JWT, login validates credentials, /me requires auth</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `uv pip install -e .` succeeds with new dependencies
- [ ] `python -c "from app.core.auth import *; from app.api.auth import router"` succeeds
- [ ] POST /api/auth/register creates user and returns JWT
- [ ] POST /api/auth/login with valid credentials returns JWT
- [ ] POST /api/auth/login with invalid credentials returns 401
- [ ] GET /api/auth/me without token returns 401
- [ ] GET /api/auth/me with valid token returns user info
- [ ] OpenAPI docs at /docs show auth endpoints
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- JWT authentication flow works end-to-end
- Protected route pattern established for other endpoints
</success_criteria>

<output>
After completion, create `.planning/phases/05-api-findings/05-01-SUMMARY.md`
</output>
