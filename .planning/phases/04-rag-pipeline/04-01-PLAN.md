---
phase: 04-standards-config
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/core/validation/standards.py
  - app/core/validation/config.py
  - app/core/validation/base.py
  - app/core/validation/grounding.py
  - app/core/validation/megger.py
  - app/core/validation/thermography.py
  - app/core/validation/__init__.py
autonomous: true

must_haves:
  truths:
    - "Same extraction can be validated against NETA or Microsoft standard"
    - "Every threshold has a traceable standard reference (e.g., 'IEEE 43-2013 Section 12.3')"
    - "Standard profile is selectable per validation call"
  artifacts:
    - path: "app/core/validation/standards.py"
      provides: "StandardProfile enum and multi-standard threshold definitions"
      contains: "class StandardProfile"
    - path: "app/core/validation/config.py"
      provides: "Enhanced ValidationConfig with standard references and profile support"
      contains: "standard_reference"
  key_links:
    - from: "app/core/validation/config.py"
      to: "app/core/validation/standards.py"
      via: "get_config_for_standard(profile)"
      pattern: "get_config_for_standard"
    - from: "app/core/validation/base.py"
      to: "get_config_for_standard"
      via: "validator initialization with standard profile"
---

<objective>
Add multi-standard profile support and audit traceability to the validation configuration.

Purpose: Enable the same test to be validated against different standards (NETA general vs Microsoft Data Center) with every threshold linked to its source standard for audit compliance.

Output: Enhanced validation config with StandardProfile enum, standard-specific thresholds, and traceability.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-rag-pipeline/04-CONTEXT.md

Existing validation config:
@app/core/validation/config.py
@app/core/validation/base.py
@app/core/validation/schemas.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create standards.py with StandardProfile enum and threshold definitions</name>
  <files>app/core/validation/standards.py</files>
  <action>
Create new module `app/core/validation/standards.py` with:

1. **StandardProfile enum** (StrEnum):
   - `NETA` — General NETA ATS requirements
   - `MICROSOFT` — Microsoft Data Center CxPOR requirements (more restrictive)

2. **ThresholdReference dataclass** (or Pydantic model):
   ```python
   class ThresholdReference(BaseModel):
       value: float | int | dict
       standard: str  # e.g., "NETA ATS-2025"
       section: str   # e.g., "Table 100.1"
       description: str  # e.g., "Maximum grounding resistance for general equipment"
   ```

3. **Standard-specific threshold dictionaries**:
   - `NETA_THRESHOLDS`: Contains all NETA ATS thresholds with references
   - `MICROSOFT_THRESHOLDS`: Contains Microsoft CxPOR thresholds with references

4. **Threshold values per standard**:

   **Grounding (resistance in Ω):**
   | Equipment | NETA | Microsoft |
   |-----------|------|-----------|
   | general | 5.0 | 5.0 |
   | data_center | 5.0 | 1.0 |
   | panel | 5.0 | 5.0 |
   | ups | 5.0 | 1.0 |
   | ats | 5.0 | 5.0 |
   | gen | 5.0 | 5.0 |
   | xfmr | 5.0 | 5.0 |
   | ground_bond | 0.1 | 0.1 |

   **Megger (same for both):**
   - min_ir_megohms: 100.0 (IEEE 43)
   - excellent_ir_megohms: 1000.0
   - min_pi: 2.0, excellent_pi: 4.0
   - min_dar: 1.25
   - min_ir_by_voltage: {500: 25, 1000: 100, 2500: 500, 5000: 1000}

   **Thermography:**
   | Level | NETA | Microsoft |
   |-------|------|-----------|
   | normal_max | 10.0 | 3.0 |
   | attention_max | 25.0 | 10.0 |
   | serious_max | 40.0 | 20.0 |
   | critical_max | 50.0 | 30.0 |

5. **Standard references** (examples):
   - Grounding NETA: "NETA ATS-2025 Table 100.1"
   - Grounding Microsoft: "Microsoft CxPOR v2.0 Section 5.3.1"
   - Megger: "IEEE 43-2013 Section 12.3"
   - Thermography NETA: "NETA MTS-2023 Table 100.18"
   - Thermography Microsoft: "Microsoft CxPOR v2.0 Section 5.4.2"

Include docstrings explaining each standard and when to use it.
  </action>
  <verify>python -c "from app.core.validation.standards import StandardProfile, NETA_THRESHOLDS, MICROSOFT_THRESHOLDS; print('OK')"</verify>
  <done>StandardProfile enum exists with NETA and MICROSOFT values; threshold dictionaries have standard_reference for every value</done>
</task>

<task type="auto">
  <name>Task 2: Enhance config.py with standard profile support</name>
  <files>app/core/validation/config.py</files>
  <action>
Update `app/core/validation/config.py`:

1. **Add standard_reference field** to each threshold class:
   - `GroundingThresholds`: Add `standard_reference: str = "NETA ATS-2025 Table 100.1"`
   - `MeggerThresholds`: Add `standard_reference: str = "IEEE 43-2013 Section 12.3"`
   - `ThermographyThresholds`: Add `standard_reference: str = "NETA MTS-2023 Table 100.18"`
   - `CalibrationConfig`: Add `standard_reference: str = "NETA ATS-2025 Section 7.2"`

2. **Add active_standard field** to ValidationConfig:
   ```python
   active_standard: StandardProfile = StandardProfile.NETA
   ```

3. **Update get_validation_config()** to accept optional standard parameter:
   ```python
   @lru_cache
   def get_validation_config(standard: StandardProfile = StandardProfile.NETA) -> ValidationConfig:
       """Get cached validation configuration for specific standard.

       Args:
           standard: Which standard profile to use (NETA or MICROSOFT).

       Returns:
           ValidationConfig with thresholds for the specified standard.
       """
       # Build config from standards.py threshold definitions
       ...
   ```

4. **Add get_config_for_standard() helper** that builds ValidationConfig from standards.py:
   ```python
   def get_config_for_standard(standard: StandardProfile) -> ValidationConfig:
       """Build validation config for a specific standard profile."""
       thresholds = NETA_THRESHOLDS if standard == StandardProfile.NETA else MICROSOFT_THRESHOLDS
       # Map thresholds to ValidationConfig structure
       ...
   ```

5. **Update lru_cache strategy** — cache per standard, not globally:
   - Keep determinism: same standard always returns same config
   - Clear typing: `get_validation_config(StandardProfile.MICROSOFT)` is explicit

Import StandardProfile, NETA_THRESHOLDS, MICROSOFT_THRESHOLDS from standards.py.
  </action>
  <verify>python -c "from app.core.validation.config import get_validation_config, StandardProfile; neta = get_validation_config(StandardProfile.NETA); ms = get_validation_config(StandardProfile.MICROSOFT); assert neta.grounding.data_center_max != ms.grounding.data_center_max; print('OK')"</verify>
  <done>get_validation_config accepts StandardProfile parameter; NETA and MICROSOFT return different thresholds; each threshold class has standard_reference field</done>
</task>

<task type="auto">
  <name>Task 3: Update validators to use standard profile and include references in findings</name>
  <files>app/core/validation/base.py, app/core/validation/grounding.py, app/core/validation/megger.py, app/core/validation/thermography.py, app/core/validation/__init__.py</files>
  <action>
1. **Update BaseValidator** (`app/core/validation/base.py`):
   - Add `standard: StandardProfile` parameter to `__init__`:
     ```python
     def __init__(
         self,
         config: ValidationConfig | None = None,
         standard: StandardProfile = StandardProfile.NETA
     ) -> None:
         self.standard = standard
         self.config = config or get_validation_config(standard)
     ```
   - Update `add_finding()` to default `standard_reference` from config if not provided:
     ```python
     def add_finding(
         self,
         ...
         standard_reference: str | None = None,
         ...
     ) -> None:
         # Use config's reference as default if none provided
         if standard_reference is None:
             standard_reference = self._get_default_reference()
     ```

2. **Update GroundingValidator** (`app/core/validation/grounding.py`):
   - Update `_validate_measurement()` to use `self.config.grounding.standard_reference`
   - Replace hardcoded "NETA ATS Table 100.1" with `self.config.grounding.standard_reference`

3. **Update MeggerValidator** (`app/core/validation/megger.py`):
   - Replace hardcoded "IEEE 43" references with `self.config.megger.standard_reference`

4. **Update ThermographyValidator** (`app/core/validation/thermography.py`):
   - Replace hardcoded references with `self.config.thermography.standard_reference`

5. **Update __init__.py** to export StandardProfile:
   - Add to imports: `from app.core.validation.standards import StandardProfile`
   - Add to `__all__`: `"StandardProfile"`

Ensure all validators pass the standard through to findings for audit trail.
  </action>
  <verify>python -c "
from app.core.validation import GroundingValidator, StandardProfile
from app.core.extraction.grounding import GroundingExtractionResult
# Create minimal extraction for test
v_neta = GroundingValidator(standard=StandardProfile.NETA)
v_ms = GroundingValidator(standard=StandardProfile.MICROSOFT)
print(f'NETA ref: {v_neta.config.grounding.standard_reference}')
print(f'MS ref: {v_ms.config.grounding.standard_reference}')
print('OK')
"</verify>
  <done>Validators accept StandardProfile; findings include correct standard_reference based on active profile; no hardcoded standard references in validator code</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from app.core.validation.standards import StandardProfile"` succeeds
- [ ] `python -c "from app.core.validation.config import get_validation_config, StandardProfile"` succeeds
- [ ] NETA and MICROSOFT configs return different thresholds for data_center grounding
- [ ] NETA and MICROSOFT configs return different thresholds for thermography
- [ ] Every threshold class has `standard_reference` field
- [ ] Validators use config's standard_reference in findings
- [ ] No TypeScript/import errors: `python -m py_compile app/core/validation/*.py`
</verification>

<success_criteria>
- All tasks completed
- StandardProfile enum with NETA and MICROSOFT values
- get_validation_config(standard) returns profile-specific thresholds
- Every threshold has traceable standard_reference
- Validators produce findings with correct standard references
- Backward compatible: `get_validation_config()` still works (defaults to NETA)
</success_criteria>

<output>
After completion, create `.planning/phases/04-rag-pipeline/04-01-SUMMARY.md`
</output>
