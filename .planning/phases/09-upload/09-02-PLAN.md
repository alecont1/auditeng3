---
phase: 09-upload
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - web/src/services/analysis.ts
  - web/src/services/index.ts
  - web/src/hooks/useUpload.ts
  - web/src/hooks/useTaskStatus.ts
  - web/src/hooks/index.ts
  - web/src/pages/UploadPage.tsx
  - web/src/types/analysis.ts
  - web/src/types/index.ts
  - web/src/components/upload/UploadProgress.tsx
  - web/src/components/upload/index.ts
autonomous: true

must_haves:
  truths:
    - "User sees upload progress percentage during file upload"
    - "User sees analysis status while processing"
    - "User is redirected to analysis details when complete"
    - "User sees error message if upload or analysis fails"
  artifacts:
    - path: "web/src/services/analysis.ts"
      provides: "Upload and status API functions"
      min_lines: 30
      contains: "submitAnalysis"
    - path: "web/src/hooks/useUpload.ts"
      provides: "Upload mutation with progress tracking"
      min_lines: 25
      contains: "onUploadProgress"
    - path: "web/src/hooks/useTaskStatus.ts"
      provides: "Task status polling hook"
      min_lines: 30
      contains: "useQuery"
    - path: "web/src/components/upload/UploadProgress.tsx"
      provides: "Progress bar component"
      min_lines: 20
  key_links:
    - from: "web/src/pages/UploadPage.tsx"
      to: "web/src/hooks/useUpload.ts"
      via: "Upload mutation for file submission"
      pattern: "useUpload"
    - from: "web/src/pages/UploadPage.tsx"
      to: "web/src/hooks/useTaskStatus.ts"
      via: "Status polling after upload"
      pattern: "useTaskStatus"
    - from: "web/src/hooks/useUpload.ts"
      to: "web/src/services/analysis.ts"
      via: "API call to submit analysis"
      pattern: "submitAnalysis"
---

<objective>
Implement upload progress tracking and status polling with automatic redirect.

Purpose: Provide real-time feedback during upload and processing, then navigate to results.
Output: Complete upload flow with progress bar, status polling, and redirect on completion.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v2.0-ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-upload/09-01-SUMMARY.md

# Existing files:
@web/src/pages/UploadPage.tsx
@web/src/lib/api.ts
@web/src/types/api.ts
@web/src/hooks/useAuth.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analysis types</name>
  <files>web/src/types/analysis.ts, web/src/types/index.ts</files>
  <action>
    Create TypeScript types for analysis API responses:

    **analysis.ts:**
    ```typescript
    /**
     * Analysis submission response
     */
    export interface SubmitAnalysisResponse {
      analysis_id: string
      task_id: string
      message: string
    }

    /**
     * Task status from polling endpoint
     */
    export type TaskStatus = 'pending' | 'processing' | 'completed' | 'failed'

    export interface TaskStatusResponse {
      task_id: string
      status: TaskStatus
      progress?: number  // 0-100
      result?: {
        analysis_id: string
      }
      error?: string
    }

    /**
     * Analysis verdict
     */
    export type Verdict = 'APPROVED' | 'REJECTED' | 'NEEDS_REVIEW'

    /**
     * Analysis summary (for list views)
     */
    export interface AnalysisSummary {
      id: string
      equipment_tag: string
      test_type: string
      equipment_type: string
      verdict: Verdict
      compliance_score: number
      confidence_score: number
      status: 'pending' | 'completed' | 'failed'
      created_at: string
      updated_at: string
    }
    ```

    **types/index.ts:**
    - Add export for analysis types
  </action>
  <verify>tsc --noEmit passes</verify>
  <done>Analysis types defined for API responses</done>
</task>

<task type="auto">
  <name>Task 2: Create analysis service functions</name>
  <files>web/src/services/analysis.ts, web/src/services/index.ts</files>
  <action>
    Create services directory and analysis API functions:

    **services/analysis.ts:**
    ```typescript
    import api from '@/lib/api'
    import type { SubmitAnalysisResponse, TaskStatusResponse } from '@/types'

    /**
     * Submit document for analysis
     * Uses multipart/form-data for file upload
     */
    export async function submitAnalysis(
      file: File,
      onUploadProgress?: (progress: number) => void
    ): Promise<SubmitAnalysisResponse> {
      const formData = new FormData()
      formData.append('file', file)

      const response = await api.post<SubmitAnalysisResponse>(
        '/analyses/submit',
        formData,
        {
          headers: {
            'Content-Type': 'multipart/form-data',
          },
          onUploadProgress: (event) => {
            if (event.total && onUploadProgress) {
              const progress = Math.round((event.loaded / event.total) * 100)
              onUploadProgress(progress)
            }
          },
        }
      )

      return response.data
    }

    /**
     * Get task status for polling
     */
    export async function getTaskStatus(taskId: string): Promise<TaskStatusResponse> {
      const response = await api.get<TaskStatusResponse>(`/tasks/${taskId}`)
      return response.data
    }
    ```

    **services/index.ts:**
    - Create barrel export file
    - Export all from analysis.ts
  </action>
  <verify>tsc --noEmit passes</verify>
  <done>Analysis service with submit and status functions</done>
</task>

<task type="auto">
  <name>Task 3: Create useUpload and useTaskStatus hooks</name>
  <files>web/src/hooks/useUpload.ts, web/src/hooks/useTaskStatus.ts, web/src/hooks/index.ts</files>
  <action>
    **useUpload.ts:**
    ```typescript
    import { useState } from 'react'
    import { useMutation } from '@tanstack/react-query'
    import { submitAnalysis } from '@/services/analysis'
    import type { SubmitAnalysisResponse } from '@/types'

    interface UseUploadResult {
      upload: (file: File) => Promise<SubmitAnalysisResponse>
      isUploading: boolean
      progress: number
      error: Error | null
      reset: () => void
    }

    export function useUpload(): UseUploadResult {
      const [progress, setProgress] = useState(0)

      const mutation = useMutation({
        mutationFn: (file: File) => submitAnalysis(file, setProgress),
        onMutate: () => setProgress(0),
      })

      return {
        upload: mutation.mutateAsync,
        isUploading: mutation.isPending,
        progress,
        error: mutation.error,
        reset: () => {
          mutation.reset()
          setProgress(0)
        },
      }
    }
    ```

    **useTaskStatus.ts:**
    ```typescript
    import { useQuery } from '@tanstack/react-query'
    import { getTaskStatus } from '@/services/analysis'
    import type { TaskStatusResponse } from '@/types'

    interface UseTaskStatusOptions {
      taskId: string | null
      enabled?: boolean
      onCompleted?: (result: TaskStatusResponse) => void
      onFailed?: (error: string) => void
    }

    export function useTaskStatus({
      taskId,
      enabled = true,
      onCompleted,
      onFailed,
    }: UseTaskStatusOptions) {
      return useQuery({
        queryKey: ['taskStatus', taskId],
        queryFn: () => getTaskStatus(taskId!),
        enabled: enabled && !!taskId,
        refetchInterval: (query) => {
          const data = query.state.data
          // Stop polling when completed or failed
          if (data?.status === 'completed' || data?.status === 'failed') {
            if (data.status === 'completed' && onCompleted) {
              onCompleted(data)
            }
            if (data.status === 'failed' && onFailed) {
              onFailed(data.error || 'Analysis failed')
            }
            return false
          }
          // Poll every 2 seconds while processing
          return 2000
        },
      })
    }
    ```

    Note: TanStack Query needs to be installed. Check if it exists, if not install it:
    ```bash
    cd web && npm install @tanstack/react-query
    ```

    Also need to add QueryClientProvider in main.tsx if not present.

    **hooks/index.ts:**
    - Add exports for useUpload, useTaskStatus
  </action>
  <verify>tsc --noEmit passes</verify>
  <done>Upload and status polling hooks with TanStack Query</done>
</task>

<task type="auto">
  <name>Task 4: Create UploadProgress component and wire up UploadPage</name>
  <files>web/src/components/upload/UploadProgress.tsx, web/src/components/upload/index.ts, web/src/pages/UploadPage.tsx, web/src/main.tsx</files>
  <action>
    **UploadProgress.tsx:**
    ```typescript
    import { Progress } from '@/components/ui/progress'
    import { Spinner } from '@/components/ui/spinner'
    import type { TaskStatus } from '@/types'

    interface UploadProgressProps {
      uploadProgress: number
      taskStatus?: TaskStatus
      taskProgress?: number
    }

    export function UploadProgress({
      uploadProgress,
      taskStatus,
      taskProgress,
    }: UploadProgressProps) {
      // During upload: show upload progress
      // After upload: show task status with spinner

      const isUploading = uploadProgress < 100
      const statusMessage = getStatusMessage(taskStatus)

      return (
        <div className="space-y-4 p-6 border rounded-lg">
          <div className="flex items-center gap-3">
            <Spinner size="sm" />
            <span className="font-medium">
              {isUploading ? 'Uploading...' : statusMessage}
            </span>
          </div>
          <Progress value={isUploading ? uploadProgress : (taskProgress || 0)} />
          <p className="text-sm text-muted-foreground">
            {isUploading
              ? `${uploadProgress}% uploaded`
              : taskStatus === 'processing'
              ? 'AI is analyzing your document...'
              : 'Please wait...'}
          </p>
        </div>
      )
    }

    function getStatusMessage(status?: TaskStatus): string {
      switch (status) {
        case 'pending': return 'Queued for processing'
        case 'processing': return 'Analyzing document'
        case 'completed': return 'Analysis complete'
        case 'failed': return 'Analysis failed'
        default: return 'Processing'
      }
    }
    ```

    Need to add shadcn Progress component:
    ```bash
    cd web && npx shadcn@latest add progress -y
    ```

    **Update UploadPage.tsx:**
    - Import useUpload, useTaskStatus, useNavigate
    - Add state for taskId after successful upload
    - Show UploadProgress during upload/processing
    - Redirect to /analysis/:id on completion
    - Show error toast on failure

    ```tsx
    export function UploadPage() {
      const navigate = useNavigate()
      const [selectedFile, setSelectedFile] = useState<File | null>(null)
      const [taskId, setTaskId] = useState<string | null>(null)

      const { upload, isUploading, progress, error, reset } = useUpload()

      const { data: taskStatus } = useTaskStatus({
        taskId,
        onCompleted: (data) => {
          toast.success('Analysis complete!')
          navigate(`/analysis/${data.result?.analysis_id}`)
        },
        onFailed: (error) => {
          toast.error(error)
          reset()
          setTaskId(null)
        },
      })

      const handleSubmit = async () => {
        if (!selectedFile) return
        try {
          const result = await upload(selectedFile)
          setTaskId(result.task_id)
        } catch (err) {
          toast.error('Upload failed. Please try again.')
        }
      }

      const isProcessing = isUploading || !!taskId

      // Show progress during upload/processing
      if (isProcessing) {
        return (
          <div className="space-y-6">
            <h1 className="text-2xl font-bold">Uploading Document</h1>
            <UploadProgress
              uploadProgress={progress}
              taskStatus={taskStatus?.status}
              taskProgress={taskStatus?.progress}
            />
          </div>
        )
      }

      // Normal upload UI...
    }
    ```

    **main.tsx:**
    - Add QueryClientProvider if not present:
    ```tsx
    import { QueryClient, QueryClientProvider } from '@tanstack/react-query'

    const queryClient = new QueryClient()

    // Wrap app with QueryClientProvider
    ```

    **components/upload/index.ts:**
    - Export UploadProgress
  </action>
  <verify>npm run dev, upload a file, see progress bar, see processing status</verify>
  <done>Upload flow complete with progress, polling, and redirect</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `cd web && npm run build` succeeds without errors
- [ ] `cd web && npx tsc --noEmit` shows no TypeScript errors
- [ ] TanStack Query is installed and QueryClientProvider is set up
- [ ] Upload shows progress percentage
- [ ] After upload, shows processing status
- [ ] API calls are made to /analyses/submit and /tasks/:id
- [ ] (Note: actual redirect requires backend - verify API calls are correct)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Upload flow works end-to-end (up to backend dependency)
- No TypeScript or build errors
</success_criteria>

<output>
After completion, create `.planning/phases/09-upload/09-02-SUMMARY.md`
</output>
