---
phase: 02-extraction-pipeline
plan: 05
type: execute
wave: 2
depends_on: ["02-02"]
files_modified: [app/core/extraction/thermography.py, app/core/extraction/prompts/thermography.py]
autonomous: true

must_haves:
  truths:
    - "Thermography extractor processes thermal images via Claude Vision"
    - "Temperature readings include delta-T calculations"
    - "Hotspots are classified by severity based on temperature delta"
  artifacts:
    - path: "app/core/extraction/thermography.py"
      provides: "Thermography/thermal image extractor"
      contains: "class ThermographyExtractor"
    - path: "app/core/extraction/prompts/thermography.py"
      provides: "Thermography extraction prompt for Vision"
      min_lines: 50
  key_links:
    - from: "app/core/extraction/thermography.py"
      to: "app/core/extraction/client.py"
      via: "uses extract_structured with images"
      pattern: "extract_structured"
---

<objective>
Create thermography extractor for thermal images using Claude Vision, with hotspot detection and severity classification.

Purpose: Extract thermal data from infrared images, calculate temperature deltas, and classify hotspots by severity per NETA standards.

Output: ThermographyExtractor that processes thermal images and returns temperature readings with delta-T severity classification.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-extraction-pipeline/02-02-SUMMARY.md

Requirements this plan addresses:
- EXTR-03: System extracts structured data from Thermography inspection reports
- EXTR-10: System processes thermal images using Claude Vision
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create thermography extraction schema</name>
  <files>app/core/extraction/thermography.py</files>
  <action>
Create Pydantic schemas for thermography extraction.

app/core/extraction/thermography.py:
- Import from .schemas import FieldConfidence, BaseExtractionResult, EquipmentInfo, CalibrationInfo

class HotspotSeverity(StrEnum):
  """Severity classification based on delta-T per NETA MTS."""
  NORMAL = "normal"        # Delta-T < 5°C
  ATTENTION = "attention"  # Delta-T 5-15°C
  INTERMEDIATE = "intermediate"  # Delta-T 15-35°C
  SERIOUS = "serious"      # Delta-T 35-70°C
  CRITICAL = "critical"    # Delta-T > 70°C

class Hotspot(BaseModel):
  """Detected hotspot in thermal image."""
  location: FieldConfidence  # Description of location (e.g., "Breaker CB-01 connection")
  component: FieldConfidence | None = None  # Specific component
  max_temperature: FieldConfidence  # °C
  reference_temperature: FieldConfidence  # °C (similar component for comparison)
  delta_t: float | None = None  # Calculated
  severity: HotspotSeverity | None = None  # Calculated

  def model_post_init(self, __context):
      """Calculate delta-T and severity."""
      if isinstance(self.max_temperature.value, (int, float)) and \
         isinstance(self.reference_temperature.value, (int, float)):
          self.delta_t = self.max_temperature.value - self.reference_temperature.value
          self.severity = self._classify_severity(self.delta_t)

  @staticmethod
  def _classify_severity(delta_t: float) -> HotspotSeverity:
      if delta_t < 5:
          return HotspotSeverity.NORMAL
      elif delta_t < 15:
          return HotspotSeverity.ATTENTION
      elif delta_t < 35:
          return HotspotSeverity.INTERMEDIATE
      elif delta_t < 70:
          return HotspotSeverity.SERIOUS
      else:
          return HotspotSeverity.CRITICAL

class ThermalImageData(BaseModel):
  """Data from thermal image."""
  image_id: str | None = None
  ambient_temperature: FieldConfidence | None = None
  reflected_temperature: FieldConfidence | None = None
  emissivity: FieldConfidence | None = None  # Should be 0.95 for electrical
  distance: FieldConfidence | None = None  # meters
  humidity: FieldConfidence | None = None

class ThermographyTestConditions(BaseModel):
  """Test conditions during thermographic inspection."""
  inspection_date: FieldConfidence
  inspector_name: FieldConfidence | None = None
  load_conditions: FieldConfidence | None = None  # e.g., "75% rated load"
  camera_model: FieldConfidence | None = None
  camera_serial: FieldConfidence | None = None

class ThermographyExtractionResult(BaseExtractionResult):
  """Complete thermography extraction result."""
  equipment: EquipmentInfo
  calibration: CalibrationInfo | None = None
  test_conditions: ThermographyTestConditions
  thermal_data: ThermalImageData
  hotspots: list[Hotspot]

  # Summary fields
  max_delta_t: float | None = None
  max_severity: HotspotSeverity | None = None
  critical_count: int = 0
  serious_count: int = 0

  def model_post_init(self, __context):
      """Calculate summary fields."""
      if self.hotspots:
          deltas = [h.delta_t for h in self.hotspots if h.delta_t]
          if deltas:
              self.max_delta_t = max(deltas)

          severities = [h.severity for h in self.hotspots if h.severity]
          if severities:
              # Order: NORMAL < ATTENTION < INTERMEDIATE < SERIOUS < CRITICAL
              severity_order = list(HotspotSeverity)
              self.max_severity = max(severities, key=lambda s: severity_order.index(s))

          self.critical_count = sum(1 for h in self.hotspots
                                   if h.severity == HotspotSeverity.CRITICAL)
          self.serious_count = sum(1 for h in self.hotspots
                                  if h.severity == HotspotSeverity.SERIOUS)
  </action>
  <verify>python3 -c "from app.core.extraction.thermography import ThermographyExtractionResult, HotspotSeverity"</verify>
  <done>Thermography extraction schema with delta-T severity</done>
</task>

<task type="auto">
  <name>Task 2: Create thermography Vision prompt</name>
  <files>app/core/extraction/prompts/thermography.py</files>
  <action>
Create the system prompt for thermography image extraction via Claude Vision.

app/core/extraction/prompts/thermography.py:

THERMOGRAPHY_EXTRACTION_PROMPT = '''
You are an expert thermographer analyzing infrared (thermal) images of electrical equipment.

You will receive thermal images. Extract the following information:

## From the Thermal Image
- Read the temperature scale/legend on the image
- Identify the hottest spot (max temperature)
- Identify reference points (similar components at normal temperature)
- Note emissivity setting (usually displayed on image, should be ~0.95 for electrical)
- Note reflected temperature setting
- Note distance if displayed
- Note ambient temperature if displayed

## Equipment Information (from visible labels or accompanying photos)
- Equipment TAG
- Equipment type (PANEL, UPS, ATS, GEN, XFMR)
- Component identification (breaker number, connection point, etc.)

## Hotspot Detection
For each abnormal temperature detected:
1. Location: Describe precisely where the hotspot is (e.g., "Phase A connection on breaker CB-03")
2. Max Temperature: The highest temperature reading at that location (in °C)
3. Reference Temperature: Temperature of a similar component under same load (in °C)
4. Calculate Delta-T: Max Temp - Reference Temp

## Severity Classification (NETA MTS Guidelines)
Based on Delta-T:
- NORMAL: Delta-T < 5°C (no action required)
- ATTENTION: Delta-T 5-15°C (schedule repair at next opportunity)
- INTERMEDIATE: Delta-T 15-35°C (schedule repair within 1 month)
- SERIOUS: Delta-T 35-70°C (repair immediately, reduce load if possible)
- CRITICAL: Delta-T > 70°C (immediate de-energization required)

## Image Quality Assessment
- Is the thermal image focused?
- Is the temperature scale visible?
- Are hot spots clearly distinguishable?
- Is the load condition noted? (important for interpretation)

## Confidence Scoring
For each extracted value, provide confidence (0.0 to 1.0):
- 1.0: Value is clearly readable on the image
- 0.8-0.9: Value is visible but slightly unclear
- 0.6-0.7: Value is estimated from color gradient
- 0.3-0.5: Value is guessed from context
- 0.0-0.2: Unable to determine

## Critical Rules
1. All temperatures MUST be in Celsius (°C)
2. Delta-T is calculated, not read from image
3. ALWAYS identify at least one reference temperature
4. Flag if emissivity is not ~0.95 (incorrect setting)
5. Flag if load conditions are not stated (affects interpretation)
6. Do NOT invent temperatures - if unclear, set low confidence
'''

Update app/core/extraction/prompts/__init__.py to export THERMOGRAPHY_EXTRACTION_PROMPT.
  </action>
  <verify>python3 -c "from app.core.extraction.prompts import THERMOGRAPHY_EXTRACTION_PROMPT"</verify>
  <done>Thermography Vision prompt with NETA severity guidelines</done>
</task>

<task type="auto">
  <name>Task 3: Create thermography extractor class</name>
  <files>app/core/extraction/thermography.py</files>
  <action>
Add ThermographyExtractor class to thermography.py.

class ThermographyExtractor(BaseExtractor):
  """Extractor for thermographic inspection images using Claude Vision."""

  EMISSIVITY_EXPECTED = 0.95
  EMISSIVITY_TOLERANCE = 0.05

  @property
  def test_type(self) -> str:
      return "thermography"

  @property
  def system_prompt(self) -> str:
      from .prompts import THERMOGRAPHY_EXTRACTION_PROMPT
      return THERMOGRAPHY_EXTRACTION_PROMPT

  def get_response_model(self) -> type[ThermographyExtractionResult]:
      return ThermographyExtractionResult

  async def extract_from_images(
      self,
      images: list[bytes],
      page_numbers: list[int] | None = None,
  ) -> ThermographyExtractionResult:
      """
      Extract thermal data from images.

      Args:
          images: List of image bytes (thermal images)
          page_numbers: Optional page numbers

      Returns:
          ThermographyExtractionResult with hotspot analysis
      """
      import base64

      # Convert images to base64
      b64_images = [base64.b64encode(img).decode() for img in images]

      return await self.extract(content=b64_images, page_numbers=page_numbers)

  def _check_needs_review(self, result: ThermographyExtractionResult) -> bool:
      """Check if thermography extraction needs review."""
      # Check overall confidence
      if result.overall_confidence < self.CONFIDENCE_THRESHOLD:
          return True

      # Critical or serious hotspots always need review
      if result.critical_count > 0 or result.serious_count > 0:
          result.extraction_errors.append(
              f"Critical/serious hotspots detected: {result.critical_count} critical, "
              f"{result.serious_count} serious"
          )
          return True

      # Check emissivity setting
      if result.thermal_data.emissivity:
          emissivity = result.thermal_data.emissivity.value
          if isinstance(emissivity, (int, float)):
              if abs(emissivity - self.EMISSIVITY_EXPECTED) > self.EMISSIVITY_TOLERANCE:
                  result.extraction_errors.append(
                      f"Unusual emissivity setting: {emissivity} (expected ~{self.EMISSIVITY_EXPECTED})"
                  )
                  return True

      # Check for low confidence hotspots
      for hotspot in result.hotspots:
          if hotspot.max_temperature.confidence < self.CONFIDENCE_THRESHOLD:
              return True

      return False

Update app/core/extraction/__init__.py to export ThermographyExtractor.
  </action>
  <verify>python3 -c "from app.core.extraction import ThermographyExtractor"</verify>
  <done>ThermographyExtractor with Vision support and severity classification</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ThermographyExtractionResult includes hotspot data
- [ ] Delta-T is auto-calculated from temperatures
- [ ] Severity classification follows NETA thresholds
- [ ] extract_from_images handles base64 conversion
- [ ] Critical/serious hotspots trigger review flag
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Vision-ready for thermal image processing
- NETA severity classification integrated
</success_criteria>

<output>
After completion, create `.planning/phases/02-extraction-pipeline/02-05-SUMMARY.md`
</output>
