---
phase: 02-extraction-pipeline
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [app/core/extraction/__init__.py, app/core/extraction/client.py, app/core/extraction/base.py, app/core/extraction/schemas.py]
autonomous: true

must_haves:
  truths:
    - "Instructor client connects to Claude API"
    - "Extraction returns Pydantic models with field-level confidence"
    - "Failed extractions retry up to 3 times automatically"
  artifacts:
    - path: "app/core/extraction/client.py"
      provides: "Instructor-wrapped Claude client"
      contains: "instructor.from_anthropic"
    - path: "app/core/extraction/base.py"
      provides: "Base extraction patterns"
      exports: ["BaseExtractor", "ExtractionResult"]
    - path: "app/core/extraction/schemas.py"
      provides: "Common extraction schemas"
      contains: "FieldConfidence"
  key_links:
    - from: "app/core/extraction/base.py"
      to: "app/core/extraction/client.py"
      via: "uses instructor client"
      pattern: "get_client"
---

<objective>
Set up Instructor with Claude for structured extraction, including retry logic and confidence scoring patterns.

Purpose: Establish the AI extraction foundation. Instructor enables reliable structured output from Claude with automatic validation and retry.

Output: Configured Instructor client with base extraction patterns that all test-type extractors will inherit.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SUMMARY.md

Requirements this plan addresses:
- EXTR-09: System retries extraction on validation failure (max 3 attempts)
- Foundation for EXTR-07 (confidence scoring pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create extraction schemas with confidence</name>
  <files>app/core/extraction/__init__.py, app/core/extraction/schemas.py</files>
  <action>
Create common extraction schemas.

app/core/extraction/schemas.py:
- FieldConfidence(BaseModel):
  - value: Any
  - confidence: float = Field(ge=0.0, le=1.0, description="Confidence score 0-1")
  - source_text: str | None = None (original text that was extracted from)

- ExtractionMetadata(BaseModel):
  - model_version: str
  - extraction_timestamp: datetime
  - page_numbers: list[int] = []
  - total_tokens_used: int = 0
  - retry_count: int = 0

- BaseExtractionResult(BaseModel):
  - metadata: ExtractionMetadata
  - overall_confidence: float = Field(ge=0.0, le=1.0)
  - extraction_errors: list[str] = []
  - needs_review: bool = False (True if any field confidence < 0.7)

- EquipmentInfo(BaseModel):
  - equipment_tag: FieldConfidence
  - serial_number: FieldConfidence | None = None
  - equipment_type: FieldConfidence
  - manufacturer: FieldConfidence | None = None
  - model: FieldConfidence | None = None

- CalibrationInfo(BaseModel):
  - certificate_number: FieldConfidence | None = None
  - calibration_date: FieldConfidence | None = None
  - expiration_date: FieldConfidence
  - calibration_lab: FieldConfidence | None = None
  - is_valid: bool = True (computed from expiration_date)

app/core/extraction/__init__.py:
- Export all schemas
  </action>
  <verify>python3 -c "from app.core.extraction import FieldConfidence, ExtractionMetadata"</verify>
  <done>Extraction schemas with confidence scoring defined</done>
</task>

<task type="auto">
  <name>Task 2: Create Instructor client wrapper</name>
  <files>app/core/extraction/client.py</files>
  <action>
Create Instructor-wrapped Claude client.

app/core/extraction/client.py:
- Import instructor
- Import anthropic
- Import from app.config import get_settings

Constants:
- DEFAULT_MODEL = "claude-sonnet-4-20250514"
- MAX_RETRIES = 3
- MAX_TOKENS = 4096

Functions:
- get_anthropic_client() -> anthropic.Anthropic:
  - Create client with API key from settings.ANTHROPIC_API_KEY
  - Cache with lru_cache

- get_instructor_client() -> instructor.Instructor:
  - Wrap anthropic client with instructor.from_anthropic()
  - Configure mode=instructor.Mode.ANTHROPIC_JSON
  - Cache with lru_cache

- async extract_structured[T: BaseModel](
    prompt: str,
    response_model: type[T],
    images: list[str] | None = None,  # base64 encoded images
    max_retries: int = MAX_RETRIES,
    model: str = DEFAULT_MODEL,
  ) -> tuple[T, ExtractionMetadata]:
  - Build messages with text and optional images
  - Call instructor client with response_model
  - Track retry count and tokens used
  - Return (result, metadata)

Handle errors:
- anthropic.APIError: Log and re-raise
- instructor.exceptions.ValidationError: Log and retry (handled by instructor)
- Timeout: Use tenacity for retry with exponential backoff

Update app/config.py to add ANTHROPIC_API_KEY setting.
  </action>
  <verify>python3 -c "from app.core.extraction.client import get_instructor_client, extract_structured"</verify>
  <done>Instructor client configured with retry logic</done>
</task>

<task type="auto">
  <name>Task 3: Create base extractor class</name>
  <files>app/core/extraction/base.py</files>
  <action>
Create abstract base extractor.

app/core/extraction/base.py:
- Import ABC, abstractmethod
- Import from .client import extract_structured
- Import from .schemas import BaseExtractionResult, ExtractionMetadata

class BaseExtractor(ABC):
  """Base class for all test-type extractors."""

  CONFIDENCE_THRESHOLD = 0.7  # Below this needs review

  @property
  @abstractmethod
  def test_type(self) -> str:
      """Return test type identifier (e.g., 'grounding', 'megger', 'thermography')"""
      pass

  @property
  @abstractmethod
  def system_prompt(self) -> str:
      """Return system prompt for extraction."""
      pass

  @abstractmethod
  def get_response_model(self) -> type[BaseExtractionResult]:
      """Return the Pydantic model for extraction response."""
      pass

  async def extract(
      self,
      content: str | list[str],  # text or list of base64 images
      page_numbers: list[int] | None = None,
  ) -> BaseExtractionResult:
      """
      Extract structured data from content.

      Args:
          content: Text content or list of base64-encoded images
          page_numbers: Optional list of page numbers being processed

      Returns:
          Extraction result with confidence scores
      """
      is_image = isinstance(content, list)

      result, metadata = await extract_structured(
          prompt=self.system_prompt,
          response_model=self.get_response_model(),
          images=content if is_image else None,
          # Include text in user message if not images
      )

      # Set needs_review based on confidence threshold
      result.needs_review = self._check_needs_review(result)
      result.metadata = metadata

      return result

  def _check_needs_review(self, result: BaseExtractionResult) -> bool:
      """Check if any field has confidence below threshold."""
      # Subclasses implement specific logic
      return result.overall_confidence < self.CONFIDENCE_THRESHOLD

Update app/core/extraction/__init__.py to export BaseExtractor.
  </action>
  <verify>python3 -c "from app.core.extraction import BaseExtractor"</verify>
  <done>Base extractor with common patterns for all test types</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Instructor client creates successfully
- [ ] extract_structured function handles retry
- [ ] BaseExtractor defines interface for test extractors
- [ ] FieldConfidence captures value + confidence + source
- [ ] ANTHROPIC_API_KEY setting exists in config
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Extraction patterns ready for test-specific implementations
- Confidence scoring integrated at field level
</success_criteria>

<output>
After completion, create `.planning/phases/02-extraction-pipeline/02-02-SUMMARY.md`
</output>
