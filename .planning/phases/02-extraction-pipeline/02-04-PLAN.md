---
phase: 02-extraction-pipeline
plan: 04
type: execute
wave: 2
depends_on: ["02-02"]
files_modified: [app/core/extraction/megger.py, app/core/extraction/prompts/megger.py]
autonomous: true

must_haves:
  truths:
    - "Megger test extractor returns insulation resistance measurements"
    - "Polarization Index (PI) is calculated when 1-min and 10-min readings exist"
    - "Calibration certificate info is extracted"
  artifacts:
    - path: "app/core/extraction/megger.py"
      provides: "Megger/insulation resistance extractor"
      contains: "class MeggerExtractor"
    - path: "app/core/extraction/prompts/megger.py"
      provides: "Megger extraction prompt"
      min_lines: 40
  key_links:
    - from: "app/core/extraction/megger.py"
      to: "app/core/extraction/base.py"
      via: "extends BaseExtractor"
      pattern: "BaseExtractor"
---

<objective>
Create Megger (insulation resistance) test extractor for IR measurements, PI calculation, and calibration data.

Purpose: Extract structured data from insulation resistance test reports following IEEE 43 standards, including Polarization Index calculation.

Output: MeggerExtractor that returns validated insulation test data with PI calculation and field-level confidence.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-extraction-pipeline/02-02-SUMMARY.md

Requirements this plan addresses:
- EXTR-02: System extracts structured data from Megger (insulation resistance) test reports
- EXTR-06: System extracts calibration certificate information (expiration, traceability)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Megger extraction schema</name>
  <files>app/core/extraction/megger.py</files>
  <action>
Create Pydantic schemas for Megger test extraction.

app/core/extraction/megger.py:
- Import from .schemas import FieldConfidence, BaseExtractionResult, EquipmentInfo, CalibrationInfo

class InsulationReading(BaseModel):
  """Single insulation resistance reading at a specific time."""
  time_seconds: int  # 15, 30, 60, 600 (10 min)
  resistance_value: FieldConfidence  # in megohms
  resistance_unit: str = "MΩ"

class MeggerMeasurement(BaseModel):
  """Complete Megger measurement for a circuit/phase."""
  circuit_id: FieldConfidence  # e.g., "Phase A-B", "L1-Ground"
  test_voltage: FieldConfidence  # e.g., 500V, 1000V, 2500V, 5000V
  readings: list[InsulationReading]

  # Calculated from readings
  ir_1min: float | None = None  # 1-minute reading in MΩ
  ir_10min: float | None = None  # 10-minute reading in MΩ
  polarization_index: float | None = None  # PI = IR10min / IR1min

  def model_post_init(self, __context):
      """Calculate IR values and PI."""
      for reading in self.readings:
          if reading.time_seconds == 60:
              self.ir_1min = reading.resistance_value.value
          elif reading.time_seconds == 600:
              self.ir_10min = reading.resistance_value.value

      if self.ir_1min and self.ir_10min and self.ir_1min > 0:
          self.polarization_index = self.ir_10min / self.ir_1min

class MeggerTestConditions(BaseModel):
  """Test conditions during Megger measurement."""
  test_date: FieldConfidence
  tester_name: FieldConfidence | None = None
  ambient_temperature: FieldConfidence | None = None  # in Celsius
  humidity: FieldConfidence | None = None  # percentage
  instrument_model: FieldConfidence | None = None
  instrument_serial: FieldConfidence | None = None

class MeggerExtractionResult(BaseExtractionResult):
  """Complete Megger test extraction result."""
  equipment: EquipmentInfo
  calibration: CalibrationInfo
  test_conditions: MeggerTestConditions
  measurements: list[MeggerMeasurement]

  # Summary fields
  min_ir: float | None = None
  min_pi: float | None = None
  all_pi_acceptable: bool = True  # PI >= 2.0 per IEEE 43

  def model_post_init(self, __context):
      """Calculate summary fields."""
      ir_values = []
      pi_values = []

      for m in self.measurements:
          if m.ir_1min:
              ir_values.append(m.ir_1min)
          if m.polarization_index:
              pi_values.append(m.polarization_index)
              if m.polarization_index < 2.0:
                  self.all_pi_acceptable = False

      if ir_values:
          self.min_ir = min(ir_values)
      if pi_values:
          self.min_pi = min(pi_values)
  </action>
  <verify>python3 -c "from app.core.extraction.megger import MeggerExtractionResult"</verify>
  <done>Megger extraction schema with PI calculation</done>
</task>

<task type="auto">
  <name>Task 2: Create Megger extraction prompt</name>
  <files>app/core/extraction/prompts/megger.py</files>
  <action>
Create the system prompt for Megger test extraction.

app/core/extraction/prompts/megger.py:

MEGGER_EXTRACTION_PROMPT = '''
You are an expert electrical engineer extracting data from insulation resistance (Megger) test reports per IEEE 43 standards.

Extract the following information with high accuracy:

## Equipment Information
- Equipment TAG (identifier)
- Serial number
- Equipment type (e.g., MOTOR, TRANSFORMER, CABLE, SWITCHGEAR)
- Manufacturer and model
- Rated voltage

## Calibration Information (CRITICAL)
- Calibration certificate number
- Calibration date
- Expiration date (MUST be extracted - reject if expired)
- Calibration laboratory
- Traceability chain (NIST, PTB, etc.)

## Test Conditions
- Test date
- Tester name
- Ambient temperature (Celsius)
- Humidity (percentage)
- Instrument model (e.g., "Megger MIT525")
- Instrument serial number

## Measurements
For each circuit/phase tested:
- Circuit identifier (e.g., "Phase A-B", "L1-Ground", "Winding-Frame")
- Test voltage (500V, 1000V, 2500V, 5000V)
- Timed readings:
  - 15-second reading (MΩ)
  - 30-second reading (MΩ)
  - 1-minute reading (MΩ) - REQUIRED for PI
  - 10-minute reading (MΩ) - REQUIRED for PI

## IEEE 43 Requirements
- Polarization Index (PI) = IR at 10 min / IR at 1 min
- PI >= 2.0 is acceptable for most equipment
- PI >= 4.0 indicates excellent insulation
- PI < 2.0 requires investigation

## Confidence Scoring
For each extracted field, provide a confidence score (0.0 to 1.0):
- 1.0: Value is clearly visible and unambiguous
- 0.8-0.9: Value is visible but slightly unclear
- 0.6-0.7: Value is partially obscured or estimated
- 0.3-0.5: Value is guessed from context
- 0.0-0.2: Value is not found or unreliable

## Critical Rules
1. All resistance values MUST be in MΩ (megohms)
2. Test voltage MUST be extracted
3. Calibration expiration is MANDATORY
4. Dates MUST be in ISO format (YYYY-MM-DD)
5. Do NOT invent values - leave as null if not found
'''

Update app/core/extraction/prompts/__init__.py to export MEGGER_EXTRACTION_PROMPT.
  </action>
  <verify>python3 -c "from app.core.extraction.prompts import MEGGER_EXTRACTION_PROMPT"</verify>
  <done>Megger extraction prompt with IEEE 43 guidance</done>
</task>

<task type="auto">
  <name>Task 3: Create Megger extractor class</name>
  <files>app/core/extraction/megger.py</files>
  <action>
Add MeggerExtractor class to megger.py.

class MeggerExtractor(BaseExtractor):
  """Extractor for insulation resistance (Megger) test reports."""

  PI_THRESHOLD = 2.0  # IEEE 43 minimum acceptable PI

  @property
  def test_type(self) -> str:
      return "megger"

  @property
  def system_prompt(self) -> str:
      from .prompts import MEGGER_EXTRACTION_PROMPT
      return MEGGER_EXTRACTION_PROMPT

  def get_response_model(self) -> type[MeggerExtractionResult]:
      return MeggerExtractionResult

  def _check_needs_review(self, result: MeggerExtractionResult) -> bool:
      """Check if Megger extraction needs review."""
      # Check overall confidence
      if result.overall_confidence < self.CONFIDENCE_THRESHOLD:
          return True

      # Check critical fields
      if result.equipment.equipment_tag.confidence < self.CONFIDENCE_THRESHOLD:
          return True

      # Calibration expiration is critical
      if result.calibration.expiration_date.confidence < 0.8:
          return True

      # Check for low PI values (needs engineering review)
      if result.min_pi and result.min_pi < self.PI_THRESHOLD:
          result.extraction_errors.append(
              f"Low Polarization Index detected: {result.min_pi:.2f} < {self.PI_THRESHOLD}"
          )
          return True

      # Check if any measurement has low confidence
      for m in result.measurements:
          if m.test_voltage.confidence < self.CONFIDENCE_THRESHOLD:
              return True

      return False

Update app/core/extraction/__init__.py to export MeggerExtractor.
  </action>
  <verify>python3 -c "from app.core.extraction import MeggerExtractor"</verify>
  <done>MeggerExtractor with IEEE 43 PI validation</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] MeggerExtractionResult schema includes all IEEE 43 fields
- [ ] Polarization Index is auto-calculated
- [ ] Prompt covers calibration requirements
- [ ] MeggerExtractor flags low PI values
- [ ] Calibration expiration is treated as critical
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- PI calculation is automatic from readings
- IEEE 43 compliance checking integrated
</success_criteria>

<output>
After completion, create `.planning/phases/02-extraction-pipeline/02-04-SUMMARY.md`
</output>
