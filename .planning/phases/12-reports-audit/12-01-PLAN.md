---
phase: 12-reports-audit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web/src/services/analysis.ts
  - web/src/components/analysis/DownloadReportButton.tsx
  - web/src/components/analysis/index.ts
  - web/src/pages/AnalysisDetailsPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can click download button to get PDF report"
    - "Loading state shows while PDF is being generated"
    - "PDF file downloads with analysis ID in filename"
    - "Error toast shows if download fails"
  artifacts:
    - path: "web/src/services/analysis.ts"
      provides: "downloadReport function with blob handling"
      contains: "downloadReport"
    - path: "web/src/components/analysis/DownloadReportButton.tsx"
      provides: "Button component with loading and error states"
      min_lines: 30
  key_links:
    - from: "DownloadReportButton.tsx"
      to: "downloadReport service"
      via: "onClick handler"
      pattern: "downloadReport"
    - from: "DownloadReportButton"
      to: "AnalysisDetailsPage"
      via: "component import"
---

<objective>
Implement PDF report download functionality for completed analyses.

Purpose: Engineers need to download professional PDF reports of their analysis results for compliance documentation and sharing with stakeholders.

Output: DownloadReportButton component integrated into AnalysisDetailsPage that triggers blob download of PDF from backend.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Backend endpoint already exists:
- GET /api/analyses/{id}/report returns application/pdf blob
- Requires authentication and analysis ownership
- Only works for completed analyses (returns 400 otherwise)

@web/src/services/analysis.ts
@web/src/components/analysis/index.ts
@web/src/pages/AnalysisDetailsPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add downloadReport service function</name>
  <files>web/src/services/analysis.ts</files>
  <action>
    Add `downloadReport(analysisId: string): Promise<void>` function that:
    1. Calls GET /api/analyses/{analysisId}/report with responseType: 'blob'
    2. Creates a Blob from the response data
    3. Creates object URL with URL.createObjectURL(blob)
    4. Creates temporary anchor element, sets href to object URL
    5. Sets download attribute to `report_${analysisId}.pdf`
    6. Programmatically clicks the anchor to trigger download
    7. Revokes object URL after download (cleanup)

    Use axios configuration: { responseType: 'blob' }
    Handle errors by re-throwing for caller to handle
  </action>
  <verify>TypeScript compiles without errors</verify>
  <done>downloadReport function exported from services/analysis.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create DownloadReportButton component</name>
  <files>web/src/components/analysis/DownloadReportButton.tsx, web/src/components/analysis/index.ts</files>
  <action>
    Create DownloadReportButton component:

    Props:
    - analysisId: string
    - disabled?: boolean (for when analysis not completed)

    Internal state:
    - isLoading: boolean (managed with useState, not useMutation since it's a download not API mutation)

    UI:
    - Use shadcn Button with variant="outline"
    - Icon: Download icon from lucide-react
    - Text: "Download Report"
    - Loading state: Spinner + "Downloading..." text
    - Disabled when isLoading or disabled prop

    onClick handler:
    1. Set isLoading true
    2. Call downloadReport(analysisId)
    3. On success: toast.success("Report downloaded")
    4. On error: toast.error("Failed to download report")
    5. Set isLoading false in finally block

    Export from index.ts
  </action>
  <verify>npm run build succeeds</verify>
  <done>DownloadReportButton component exists with loading states and toast feedback</done>
</task>

<task type="auto">
  <name>Task 3: Integrate into AnalysisDetailsPage</name>
  <files>web/src/pages/AnalysisDetailsPage.tsx</files>
  <action>
    Add DownloadReportButton to AnalysisDetailsPage:

    1. Import DownloadReportButton from @/components/analysis
    2. Add button in the AnalysisHeader section or near the top actions
    3. Pass analysisId prop
    4. Disable when analysis status is not 'completed' (check the data object)

    Position: Near other action buttons (approve/reject) or in header area

    Only show/enable for completed analyses - add conditional:
    - If analysis.verdict exists (meaning completed), enable button
    - Otherwise disable with tooltip explaining why
  </action>
  <verify>npm run build succeeds</verify>
  <done>DownloadReportButton visible on AnalysisDetailsPage, disabled for incomplete analyses</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] downloadReport function handles blob response correctly
- [ ] DownloadReportButton shows loading spinner during download
- [ ] Button is disabled for non-completed analyses
- [ ] Toast notification shows on success/failure
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- PDF download triggers via blob URL pattern
- User sees clear loading and feedback states
</success_criteria>

<output>
After completion, create `.planning/phases/12-reports-audit/12-01-SUMMARY.md`
</output>
