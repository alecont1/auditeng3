---
phase: 06-reporting-audit
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - app/api/reports.py
  - app/main.py
  - app/tests/api/test_reports.py
autonomous: true

must_haves:
  truths:
    - "User can download PDF via GET /api/analyses/{id}/report"
    - "Endpoint requires authentication"
    - "Endpoint returns PDF with correct Content-Type"
    - "404 returned for non-existent analysis"
    - "403 returned for unauthorized access"
  artifacts:
    - path: "app/api/reports.py"
      provides: "Report download endpoint"
      exports: ["router"]
    - path: "app/tests/api/test_reports.py"
      provides: "Integration tests for report endpoint"
  key_links:
    - from: "app/api/reports.py"
      to: "ReportService"
      via: "generate_pdf call"
      pattern: "ReportService.generate_pdf"
    - from: "app/main.py"
      to: "reports_router"
      via: "include_router"
      pattern: "reports_router"
---

<objective>
Create report download API endpoint for PDF retrieval.

Purpose: Complete REPT-06 requirement - users can download PDF reports via authenticated API endpoint. Uses ReportService from 06-01.

Output: Protected endpoint GET /api/analyses/{analysis_id}/report returning PDF bytes with proper Content-Disposition header.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-reporting-audit/06-01-PLAN.md

# Uses patterns from Phase 5 API
@app/api/analyses.py
@app/core/auth.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create report download endpoint</name>
  <files>app/api/reports.py</files>
  <action>
Create app/api/reports.py with:

1. Router with prefix="/api/analyses" and tags=["reports"]

2. GET /{analysis_id}/report endpoint:
   - Parameters: analysis_id: UUID
   - Dependencies: DbSession, CurrentUser (from app.core.auth)
   - Process:
     a. Reuse verify_analysis_ownership from app.api.analyses (import it)
     b. Check task.status == COMPLETED, else return 400 "Analysis not complete"
     c. Call ReportService.from_analysis(analysis)
     d. Call ReportService.generate_pdf(report_data)
     e. Return Response with:
        - content=pdf_bytes
        - media_type="application/pdf"
        - headers={"Content-Disposition": f'attachment; filename="report_{analysis_id}.pdf"'}
   - Responses:
     - 200: PDF file download
     - 400: Analysis not complete
     - 401: Not authenticated
     - 403: Access denied
     - 404: Analysis not found

DO NOT create a new ownership verification function - import and reuse from analyses.py.
  </action>
  <verify>python -c "from app.api.reports import router; print('OK')"</verify>
  <done>Report endpoint created with authentication and ownership checks</done>
</task>

<task type="auto">
  <name>Task 2: Register reports router in main app</name>
  <files>app/main.py</files>
  <action>
1. Import: from app.api.reports import router as reports_router
2. Add reports_router to app.include_router() calls
3. Add "reports" tag to OpenAPI tags list with description "PDF report generation and download"

Keep the import grouped with other API router imports.
  </action>
  <verify>python -c "from app.main import app; print([r.path for r in app.routes if 'report' in r.path])"</verify>
  <done>Reports router registered, endpoint visible in OpenAPI</done>
</task>

<task type="auto">
  <name>Task 3: Add integration tests for report endpoint</name>
  <files>app/tests/api/test_reports.py</files>
  <action>
Create integration tests for report endpoint:

1. test_download_report_requires_auth:
   - GET /api/analyses/{uuid}/report without token
   - Assert 401

2. test_download_report_returns_pdf:
   - Create mock completed analysis with findings
   - GET with valid auth token
   - Assert 200
   - Assert Content-Type is application/pdf
   - Assert Content-Disposition header present
   - Assert body starts with b'%PDF-'

3. test_download_report_incomplete_analysis:
   - Create analysis with task.status = PROCESSING
   - GET with auth
   - Assert 400

4. test_download_report_not_found:
   - GET /api/analyses/{random_uuid}/report with auth
   - Assert 404

5. test_download_report_wrong_user:
   - Create analysis owned by user A
   - GET with token for user B
   - Assert 403

Use fixtures from app/tests/api/conftest.py.
Since SQLite doesn't fully support PostgreSQL features, focus tests on:
- Auth requirement (no DB needed)
- Response format validation
  </action>
  <verify>cd /home/xande && python -m pytest app/tests/api/test_reports.py -v</verify>
  <done>5 integration tests passing for report endpoint</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from app.api.reports import router"` works
- [ ] Report endpoint appears in OpenAPI docs at /docs
- [ ] `python -m pytest app/tests/api/test_reports.py -v` passes all tests
- [ ] curl test with valid token returns PDF (manual if possible)
</verification>

<success_criteria>
- All tasks completed
- GET /api/analyses/{id}/report endpoint functional
- Endpoint requires authentication
- Endpoint returns PDF with correct headers
- Ownership verification prevents unauthorized access
- 5 integration tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/06-reporting-audit/06-02-SUMMARY.md`
</output>
