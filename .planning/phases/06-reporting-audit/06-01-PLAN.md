---
phase: 06-reporting-audit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/services/report.py
  - app/schemas/report.py
  - app/tests/services/test_report.py
  - pyproject.toml
autonomous: true

must_haves:
  truths:
    - "PDF is generated with valid structure"
    - "Executive summary shows verdict and severity counts"
    - "Each finding displays code, severity, message, remediation"
    - "Standard references appear for each finding"
  artifacts:
    - path: "app/services/report.py"
      provides: "ReportService with generate_pdf method"
      min_lines: 100
    - path: "app/schemas/report.py"
      provides: "ReportData schema for PDF generation"
  key_links:
    - from: "app/services/report.py"
      to: "Analysis model"
      via: "ReportData from analysis"
      pattern: "ReportData"
---

<objective>
Create PDF report generation service using ReportLab for professional commissioning audit reports.

Purpose: Enable engineers to download actionable PDF reports with findings, severity indicators, and remediation guidance. The report must be DIRETO E ACIONAVEL - engineer reads fast and acts.

Output: ReportService that generates PDF from Analysis data with executive summary, findings table, and standard references.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-reporting-audit/06-CONTEXT.md

# Phase 5 provides the data structures we need
@.planning/phases/05-api-findings/05-02-SUMMARY.md
@.planning/phases/05-api-findings/05-03-SUMMARY.md

# Existing code references
@app/db/models/analysis.py
@app/db/models/finding.py
@app/api/schemas.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ReportLab dependency and create report schemas</name>
  <files>pyproject.toml, app/schemas/report.py</files>
  <action>
1. Add reportlab>=4.0.0 to pyproject.toml dependencies
2. Create app/schemas/report.py with:
   - ReportFinding: rule_id, severity, message, remediation, standard_reference
   - SeverityCounts: critical, major, minor, info counts
   - ReportData: analysis_id, equipment_type, test_type, equipment_tag, verdict, compliance_score, confidence_score, severity_counts, findings list, generated_at
   - Use Pydantic BaseModel with model_config = {"from_attributes": True}

DO NOT use complex nested inheritance. Keep schemas flat and simple.
  </action>
  <verify>python -c "from app.schemas.report import ReportData, ReportFinding, SeverityCounts; print('OK')"</verify>
  <done>ReportLab added to deps, report schemas importable</done>
</task>

<task type="auto">
  <name>Task 2: Create ReportService with PDF generation</name>
  <files>app/services/report.py, app/services/__init__.py</files>
  <action>
Create app/services/report.py with ReportService class:

1. Static method `from_analysis(analysis: Analysis) -> ReportData`:
   - Convert Analysis model to ReportData schema
   - Count findings by severity
   - Extract standard_reference from each finding's evidence dict
   - Return ReportData instance

2. Static method `generate_pdf(data: ReportData) -> bytes`:
   - Use ReportLab SimpleDocTemplate with BytesIO
   - Page setup: A4, 72pt margins
   - Structure:
     a. Header: "AuditEng Analysis Report" + report number + date
     b. Executive Summary section:
        - Verdict badge (APPROVED=green, REVIEW=yellow, REJECTED=red) - use colors
        - Compliance score as percentage
        - Severity counts table: CRITICAL | MAJOR | MINOR | INFO
        - Equipment: type, tag (if present)
     c. Findings section:
        - Table with columns: Code | Severity | Description | Remediation | Standard
        - Row background color by severity (light red for CRITICAL, light yellow for MAJOR, white for MINOR/INFO)
        - Wrap long text in cells
     d. Footer: "Generated by AuditEng" + timestamp
   - Return PDF bytes

Design must be MINIMAL and ENGINEER-FOCUSED:
- No unnecessary graphics or branding firulas
- Clear severity indicators (color + text)
- Actionable remediation text visible
- Standard reference for audit compliance
  </action>
  <verify>python -c "from app.services.report import ReportService; print('OK')"</verify>
  <done>ReportService with from_analysis and generate_pdf methods</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for report generation</name>
  <files>app/tests/services/test_report.py</files>
  <action>
Create comprehensive tests for ReportService:

1. test_from_analysis_creates_report_data:
   - Mock Analysis with findings
   - Verify ReportData has correct equipment info, verdict, scores
   - Verify severity counts are accurate

2. test_from_analysis_counts_severities:
   - Create findings with mixed severities (2 CRITICAL, 3 MAJOR, 1 MINOR)
   - Assert severity_counts matches

3. test_generate_pdf_returns_bytes:
   - Create ReportData with sample findings
   - Call generate_pdf
   - Assert result is bytes
   - Assert starts with PDF magic number b'%PDF-'

4. test_generate_pdf_includes_findings:
   - Generate PDF
   - Assert len > 1000 bytes (substantial content)

5. test_generate_pdf_handles_empty_findings:
   - ReportData with empty findings list
   - Should still generate valid PDF

6. test_generate_pdf_handles_long_text:
   - Finding with very long remediation text (500+ chars)
   - Should not crash, PDF should be valid

Use pytest fixtures for sample Analysis and ReportData.
  </action>
  <verify>cd /home/xande && python -m pytest app/tests/services/test_report.py -v</verify>
  <done>6+ tests passing for ReportService</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pip install reportlab` succeeds (or already installed via pyproject.toml)
- [ ] `python -c "from app.services.report import ReportService"` works
- [ ] `python -m pytest app/tests/services/test_report.py -v` passes all tests
- [ ] Generated PDF opens correctly (manual spot check if possible)
</verification>

<success_criteria>
- All tasks completed
- ReportService.from_analysis() converts Analysis to ReportData
- ReportService.generate_pdf() produces valid PDF bytes
- PDF includes executive summary with verdict and scores
- PDF includes findings table with severity colors
- 6+ unit tests passing
</success_criteria>

<output>
After completion, create `.planning/phases/06-reporting-audit/06-01-SUMMARY.md`
</output>
