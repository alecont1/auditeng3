---
phase: 01-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-02"]
files_modified: [alembic.ini, alembic/env.py, alembic/script.py.mako, alembic/versions/0001_initial_schema.py]
autonomous: true

must_haves:
  truths:
    - "Alembic can generate migrations from model changes"
    - "Migration runs successfully against empty database"
    - "Downgrade removes all tables cleanly"
  artifacts:
    - path: "alembic.ini"
      provides: "Alembic configuration"
      contains: "sqlalchemy.url"
    - path: "alembic/env.py"
      provides: "Async migration environment"
      contains: "run_async_migrations"
    - path: "alembic/versions/0001_initial_schema.py"
      provides: "Initial database schema"
      contains: "create_table"
  key_links:
    - from: "alembic/env.py"
      to: "app/db/base.py"
      via: "imports Base.metadata"
      pattern: "from app.db.*import.*Base"
---

<objective>
Initialize Alembic with async support and create the initial database migration for all models.

Purpose: Establish version-controlled database schema evolution. Migrations enable safe schema changes in production without data loss.

Output: Working Alembic setup with async PostgreSQL support and initial migration covering all tables.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

Requirements this plan addresses:
- DATA-03: System uses Alembic for database migrations
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Alembic with async configuration</name>
  <files>alembic.ini, alembic/env.py, alembic/script.py.mako</files>
  <action>
Initialize Alembic and configure for async PostgreSQL.

Run: alembic init alembic

Then modify alembic.ini:
- Set sqlalchemy.url to use environment variable: %(DATABASE_URL)s
- Or use: postgresql+asyncpg://postgres:postgres@localhost:5432/auditeng

Modify alembic/env.py for async:
- Import asyncio
- Import create_async_engine from sqlalchemy.ext.asyncio
- Import Base from app.db.base
- Set target_metadata = Base.metadata
- Create run_async_migrations() function:
  - Create async engine
  - Use async with connectable.connect() as connection
  - await connection.run_sync(do_run_migrations)
- Replace run_migrations_online() to call asyncio.run(run_async_migrations())
- Import all models at top to ensure they register with Base.metadata:
  from app.db.models import User, Task, Analysis, Finding

Keep alembic/script.py.mako as default (it's fine for async).
  </action>
  <verify>alembic current (should show no revisions yet)</verify>
  <done>Alembic initialized with async support</done>
</task>

<task type="auto">
  <name>Task 2: Create initial schema migration</name>
  <files>alembic/versions/0001_initial_schema.py</files>
  <action>
Generate and verify the initial migration.

Run: alembic revision --autogenerate -m "initial_schema"

Verify the generated migration includes:
- users table with all columns (id, email, hashed_password, is_active, created_at, updated_at)
- tasks table with all columns and foreign key to users
- analyses table with all columns and foreign key to tasks
- findings table with all columns and foreign key to analyses

Ensure proper index creation:
- ix_users_email (unique)
- ix_tasks_user_id
- ix_tasks_status
- ix_analyses_task_id (unique constraint)
- ix_findings_analysis_id
- ix_findings_severity

Check downgrade function properly drops all tables in reverse order:
- findings → analyses → tasks → users

Rename the generated file to 0001_initial_schema.py for clarity.
  </action>
  <verify>alembic upgrade head && alembic downgrade base (requires running PostgreSQL)</verify>
  <done>Initial migration created with all tables and relationships</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] alembic.ini configured for async PostgreSQL
- [ ] env.py uses async engine properly
- [ ] All 4 tables in migration (users, tasks, analyses, findings)
- [ ] Foreign keys and indexes properly defined
- [ ] Upgrade and downgrade functions are complete
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Migration can be applied to empty database
- Migration can be rolled back cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
