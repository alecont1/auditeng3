---
phase: 03-validation-engine
plan: 02
type: execute
wave: 2
depends_on: [03-01]
files_modified: [app/core/validation/grounding.py]
autonomous: true

must_haves:
  truths:
    - "Grounding resistance is validated against NETA thresholds"
    - "Each measurement produces Finding with severity"
    - "Validator uses externalized config thresholds"
  artifacts:
    - path: "app/core/validation/grounding.py"
      provides: "GroundingValidator class"
      exports: ["GroundingValidator"]
  key_links:
    - from: "grounding.py"
      to: "base.py"
      via: "extends BaseValidator"
      pattern: "class GroundingValidator(BaseValidator)"
    - from: "grounding.py"
      to: "config.py"
      via: "uses GroundingThresholds"
      pattern: "self.config.grounding"
---

<objective>
Create GroundingValidator to validate grounding resistance measurements.

Purpose: Validate extracted grounding data against NETA ATS thresholds (VALD-01).
Output: GroundingValidator class that produces ValidationResult with Findings.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-validation-engine/03-01-SUMMARY.md

Requirements this plan addresses:
- VALD-01: System validates grounding resistance against NETA/IEEE thresholds

Extraction schema reference:
- GroundingExtractionResult from app/core/extraction/grounding.py
- Contains: equipment, measurements (list[GroundingMeasurement])
- Each measurement has: resistance_value, test_point

Threshold reference (from 03-01 config):
- general_max: 5.0Ω
- data_center_max: 1.0Ω (Microsoft CxPOR)
- Equipment-specific thresholds available
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GroundingValidator</name>
  <files>app/core/validation/grounding.py</files>
  <action>
Create GroundingValidator that validates each measurement.

app/core/validation/grounding.py:
- Import from app.core.validation.base import BaseValidator
- Import from app.core.validation.schemas import Finding, ValidationResult, ValidationSeverity
- Import from app.core.extraction.grounding import GroundingExtractionResult
- Import from app.schemas.enums import EquipmentType

class GroundingValidator(BaseValidator):
    """Validator for grounding resistance measurements."""

    @property
    def test_type(self) -> str:
        return "grounding"

    def validate(self, extraction: GroundingExtractionResult) -> ValidationResult:
        """Validate grounding extraction against NETA thresholds."""
        findings: list[Finding] = []

        # Get equipment type for threshold lookup
        equipment_type = self._get_equipment_type(extraction)
        threshold = self.config.grounding.get_threshold(equipment_type)

        # Get equipment tag for result
        equipment_tag = extraction.equipment.equipment_tag.value

        # Validate each measurement
        for i, measurement in enumerate(extraction.measurements):
            self._validate_measurement(
                findings=findings,
                measurement=measurement,
                index=i,
                threshold=threshold,
            )

        return self.create_result(findings, equipment_tag=equipment_tag)

    def _get_equipment_type(self, extraction: GroundingExtractionResult) -> EquipmentType | None:
        """Extract equipment type from extraction result."""
        try:
            type_value = extraction.equipment.equipment_type.value
            return EquipmentType(type_value) if type_value else None
        except (ValueError, AttributeError):
            return None

    def _validate_measurement(
        self,
        findings: list[Finding],
        measurement: GroundingMeasurement,
        index: int,
        threshold: float,
    ) -> None:
        """Validate single measurement against threshold."""
        resistance = measurement.resistance_value.value

        if not isinstance(resistance, (int, float)):
            self.add_finding(
                findings=findings,
                rule_id="GRND-001",
                severity=ValidationSeverity.MAJOR,
                message=f"Invalid resistance value: {resistance}",
                field_path=f"measurements[{index}].resistance_value",
                extracted_value=resistance,
                threshold=threshold,
                remediation="Verify resistance measurement is a valid number",
            )
            return

        resistance = float(resistance)

        if resistance > threshold:
            # Determine severity based on how far over threshold
            if resistance > threshold * 2:
                severity = ValidationSeverity.CRITICAL
            elif resistance > threshold * 1.5:
                severity = ValidationSeverity.MAJOR
            else:
                severity = ValidationSeverity.MINOR

            self.add_finding(
                findings=findings,
                rule_id="GRND-002",
                severity=severity,
                message=f"Grounding resistance {resistance:.2f}Ω exceeds threshold {threshold:.2f}Ω",
                field_path=f"measurements[{index}].resistance_value",
                extracted_value=resistance,
                threshold=threshold,
                standard_reference="NETA ATS Table 100.1",
                remediation="Investigate ground connection, consider adding ground rods",
            )
        else:
            # Add INFO finding for passing values
            self.add_finding(
                findings=findings,
                rule_id="GRND-003",
                severity=ValidationSeverity.INFO,
                message=f"Grounding resistance {resistance:.2f}Ω within threshold",
                field_path=f"measurements[{index}].resistance_value",
                extracted_value=resistance,
                threshold=threshold,
                standard_reference="NETA ATS Table 100.1",
            )
  </action>
  <verify>python3 -c "from app.core.validation.grounding import GroundingValidator; print('✓ GroundingValidator imports')"</verify>
  <done>GroundingValidator validates resistance against NETA thresholds</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] GroundingValidator extends BaseValidator
- [ ] validate() returns ValidationResult
- [ ] Findings include rule_id, severity, message
- [ ] Threshold comes from config.grounding
- [ ] Standard reference is "NETA ATS Table 100.1"
</verification>

<success_criteria>
- All tasks completed
- GroundingValidator works with extraction results
- Severity escalates based on deviation from threshold
- VALD-01 requirements addressed
</success_criteria>

<output>
After completion, create `.planning/phases/03-validation-engine/03-02-SUMMARY.md`
</output>
