---
phase: 03-validation-engine
plan: 03
type: execute
wave: 2
depends_on: [03-01]
files_modified: [app/core/validation/megger.py]
autonomous: true

must_haves:
  truths:
    - "Insulation resistance validated against IEEE 43"
    - "Polarization Index validated (PI >= 2.0)"
    - "Minimum IR validated based on test voltage"
  artifacts:
    - path: "app/core/validation/megger.py"
      provides: "MeggerValidator class"
      exports: ["MeggerValidator"]
  key_links:
    - from: "megger.py"
      to: "base.py"
      via: "extends BaseValidator"
      pattern: "class MeggerValidator(BaseValidator)"
---

<objective>
Create MeggerValidator to validate insulation resistance per IEEE 43.

Purpose: Validate Megger test results against IEEE 43 standards (VALD-02).
Output: MeggerValidator with PI and IR threshold validation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-validation-engine/03-01-SUMMARY.md

Requirements this plan addresses:
- VALD-02: System validates insulation resistance against IEEE 43 standards

Extraction schema reference:
- MeggerExtractionResult from app/core/extraction/megger.py
- Contains: measurements (list[MeggerMeasurement])
- Each measurement has: polarization_index, ir_1min, test_voltage

Threshold reference (from 03-01 config):
- min_pi: 2.0
- min_ir_megohms: 100.0
- min_ir_by_voltage: {500: 25, 1000: 100, 2500: 500, 5000: 1000}
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MeggerValidator</name>
  <files>app/core/validation/megger.py</files>
  <action>
Create MeggerValidator that validates PI and IR.

app/core/validation/megger.py:
- Import from app.core.validation.base import BaseValidator
- Import from app.core.validation.schemas import Finding, ValidationResult, ValidationSeverity
- Import from app.core.extraction.megger import MeggerExtractionResult, MeggerMeasurement

class MeggerValidator(BaseValidator):
    """Validator for insulation resistance (Megger) tests per IEEE 43."""

    @property
    def test_type(self) -> str:
        return "megger"

    def validate(self, extraction: MeggerExtractionResult) -> ValidationResult:
        """Validate Megger extraction against IEEE 43."""
        findings: list[Finding] = []
        equipment_tag = extraction.equipment.equipment_tag.value

        for i, measurement in enumerate(extraction.measurements):
            self._validate_polarization_index(findings, measurement, i)
            self._validate_insulation_resistance(findings, measurement, i)

        return self.create_result(findings, equipment_tag=equipment_tag)

    def _validate_polarization_index(
        self,
        findings: list[Finding],
        measurement: MeggerMeasurement,
        index: int,
    ) -> None:
        """Validate Polarization Index >= 2.0 per IEEE 43."""
        pi = measurement.polarization_index
        min_pi = self.config.megger.min_pi

        if pi is None:
            self.add_finding(
                findings=findings,
                rule_id="MEGG-001",
                severity=ValidationSeverity.MAJOR,
                message="Polarization Index not calculated (missing 1min or 10min reading)",
                field_path=f"measurements[{index}].polarization_index",
                extracted_value=None,
                threshold=min_pi,
                standard_reference="IEEE 43 Section 12.3",
                remediation="Ensure 1-minute and 10-minute readings are recorded",
            )
            return

        if pi < min_pi:
            severity = ValidationSeverity.CRITICAL if pi < 1.5 else ValidationSeverity.MAJOR
            self.add_finding(
                findings=findings,
                rule_id="MEGG-002",
                severity=severity,
                message=f"Polarization Index {pi:.2f} below minimum {min_pi}",
                field_path=f"measurements[{index}].polarization_index",
                extracted_value=pi,
                threshold=min_pi,
                standard_reference="IEEE 43 Table 3",
                remediation="Insulation may be contaminated or degraded. Investigate cause.",
            )
        else:
            self.add_finding(
                findings=findings,
                rule_id="MEGG-003",
                severity=ValidationSeverity.INFO,
                message=f"Polarization Index {pi:.2f} acceptable",
                field_path=f"measurements[{index}].polarization_index",
                extracted_value=pi,
                threshold=min_pi,
                standard_reference="IEEE 43 Table 3",
            )

    def _validate_insulation_resistance(
        self,
        findings: list[Finding],
        measurement: MeggerMeasurement,
        index: int,
    ) -> None:
        """Validate IR against voltage-based thresholds."""
        ir_value = measurement.ir_1min
        test_voltage = measurement.test_voltage.value

        if ir_value is None:
            return  # Already flagged in PI validation

        if not isinstance(test_voltage, (int, float)):
            return

        min_ir = self.config.megger.get_min_ir_for_voltage(int(test_voltage))

        if ir_value < min_ir:
            severity = ValidationSeverity.CRITICAL if ir_value < min_ir * 0.5 else ValidationSeverity.MAJOR
            self.add_finding(
                findings=findings,
                rule_id="MEGG-004",
                severity=severity,
                message=f"Insulation resistance {ir_value:.1f}MΩ below minimum {min_ir}MΩ for {test_voltage}V test",
                field_path=f"measurements[{index}].ir_1min",
                extracted_value=ir_value,
                threshold=min_ir,
                standard_reference="IEEE 43 Table 4",
                remediation="Low insulation resistance indicates degradation. Investigate moisture, contamination, or aging.",
            )
        else:
            self.add_finding(
                findings=findings,
                rule_id="MEGG-005",
                severity=ValidationSeverity.INFO,
                message=f"Insulation resistance {ir_value:.1f}MΩ acceptable for {test_voltage}V test",
                field_path=f"measurements[{index}].ir_1min",
                extracted_value=ir_value,
                threshold=min_ir,
                standard_reference="IEEE 43 Table 4",
            )
  </action>
  <verify>python3 -c "from app.core.validation.megger import MeggerValidator; print('✓ MeggerValidator imports')"</verify>
  <done>MeggerValidator validates PI and IR per IEEE 43</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] MeggerValidator extends BaseValidator
- [ ] PI validation with threshold 2.0
- [ ] IR validation based on test voltage
- [ ] Findings reference IEEE 43
</verification>

<success_criteria>
- All tasks completed
- VALD-02 requirements addressed
- IEEE 43 references included
</success_criteria>

<output>
After completion, create `.planning/phases/03-validation-engine/03-03-SUMMARY.md`
</output>
