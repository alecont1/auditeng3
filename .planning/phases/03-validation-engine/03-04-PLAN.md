---
phase: 03-validation-engine
plan: 04
type: execute
wave: 2
depends_on: [03-01]
files_modified: [app/core/validation/thermography.py]
autonomous: true

must_haves:
  truths:
    - "Thermography delta-T validated against NETA MTS"
    - "Hotspots classified by severity thresholds"
    - "Critical hotspots produce CRITICAL findings"
  artifacts:
    - path: "app/core/validation/thermography.py"
      provides: "ThermographyValidator class"
      exports: ["ThermographyValidator"]
  key_links:
    - from: "thermography.py"
      to: "base.py"
      via: "extends BaseValidator"
      pattern: "class ThermographyValidator(BaseValidator)"
---

<objective>
Create ThermographyValidator to validate temperature deltas per NETA MTS.

Purpose: Validate thermography hotspots against severity thresholds (VALD-03).
Output: ThermographyValidator with delta-T classification.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-validation-engine/03-01-SUMMARY.md

Requirements this plan addresses:
- VALD-03: System validates thermography temperature deltas against severity thresholds

Extraction schema reference:
- ThermographyExtractionResult from app/core/extraction/thermography.py
- Contains: hotspots (list[Hotspot])
- Each hotspot has: delta_t, severity, max_temperature, reference_temperature

Threshold reference (from 03-01 config):
- normal_max: 5.0°C
- attention_max: 15.0°C
- intermediate_max: 35.0°C
- serious_max: 70.0°C
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ThermographyValidator</name>
  <files>app/core/validation/thermography.py</files>
  <action>
Create ThermographyValidator that validates delta-T.

app/core/validation/thermography.py:
- Import from app.core.validation.base import BaseValidator
- Import from app.core.validation.schemas import Finding, ValidationResult, ValidationSeverity
- Import from app.core.extraction.thermography import ThermographyExtractionResult, Hotspot, HotspotSeverity

class ThermographyValidator(BaseValidator):
    """Validator for thermographic inspections per NETA MTS."""

    @property
    def test_type(self) -> str:
        return "thermography"

    def validate(self, extraction: ThermographyExtractionResult) -> ValidationResult:
        """Validate thermography extraction against NETA MTS."""
        findings: list[Finding] = []
        equipment_tag = extraction.equipment.equipment_tag.value

        # No hotspots = good news
        if not extraction.hotspots:
            self.add_finding(
                findings=findings,
                rule_id="THRM-001",
                severity=ValidationSeverity.INFO,
                message="No thermal anomalies detected",
                field_path="hotspots",
                extracted_value=0,
                threshold="None expected",
                standard_reference="NETA MTS Table 100.18",
            )
        else:
            for i, hotspot in enumerate(extraction.hotspots):
                self._validate_hotspot(findings, hotspot, i)

        return self.create_result(findings, equipment_tag=equipment_tag)

    def _validate_hotspot(
        self,
        findings: list[Finding],
        hotspot: Hotspot,
        index: int,
    ) -> None:
        """Validate single hotspot delta-T."""
        delta_t = hotspot.delta_t
        thermo_config = self.config.thermography

        if delta_t is None:
            self.add_finding(
                findings=findings,
                rule_id="THRM-002",
                severity=ValidationSeverity.MAJOR,
                message="Unable to calculate temperature delta",
                field_path=f"hotspots[{index}].delta_t",
                extracted_value=None,
                threshold="Calculable delta-T required",
                remediation="Verify max and reference temperatures are present",
            )
            return

        # Map extracted severity to ValidationSeverity
        severity_map = {
            "normal": ValidationSeverity.INFO,
            "attention": ValidationSeverity.MINOR,
            "intermediate": ValidationSeverity.MAJOR,
            "serious": ValidationSeverity.MAJOR,
            "critical": ValidationSeverity.CRITICAL,
        }

        classification = thermo_config.classify_delta(delta_t)
        validation_severity = severity_map.get(classification, ValidationSeverity.INFO)

        location = hotspot.location.value if hotspot.location else "Unknown"

        # Build threshold description
        if classification == "normal":
            threshold_desc = f"≤{thermo_config.normal_max}°C"
        elif classification == "attention":
            threshold_desc = f"{thermo_config.normal_max}-{thermo_config.attention_max}°C"
        elif classification == "intermediate":
            threshold_desc = f"{thermo_config.attention_max}-{thermo_config.intermediate_max}°C"
        elif classification == "serious":
            threshold_desc = f"{thermo_config.intermediate_max}-{thermo_config.serious_max}°C"
        else:
            threshold_desc = f">{thermo_config.serious_max}°C"

        # Build message based on classification
        messages = {
            "normal": f"Hotspot at {location}: ΔT={delta_t:.1f}°C - within normal range",
            "attention": f"Hotspot at {location}: ΔT={delta_t:.1f}°C - schedule repair at next opportunity",
            "intermediate": f"Hotspot at {location}: ΔT={delta_t:.1f}°C - schedule repair within 1 month",
            "serious": f"Hotspot at {location}: ΔT={delta_t:.1f}°C - repair immediately, reduce load if possible",
            "critical": f"Hotspot at {location}: ΔT={delta_t:.1f}°C - IMMEDIATE DE-ENERGIZATION REQUIRED",
        }

        remediation_map = {
            "normal": None,
            "attention": "Schedule repair during next maintenance window",
            "intermediate": "Plan corrective action within 30 days",
            "serious": "Immediate repair required. Consider load reduction until repaired.",
            "critical": "De-energize immediately. Do not re-energize until repaired.",
        }

        self.add_finding(
            findings=findings,
            rule_id=f"THRM-{classification.upper()[:3]}",
            severity=validation_severity,
            message=messages[classification],
            field_path=f"hotspots[{index}].delta_t",
            extracted_value=delta_t,
            threshold=threshold_desc,
            standard_reference="NETA MTS Table 100.18",
            remediation=remediation_map[classification],
        )
  </action>
  <verify>python3 -c "from app.core.validation.thermography import ThermographyValidator; print('✓ ThermographyValidator imports')"</verify>
  <done>ThermographyValidator validates delta-T per NETA MTS</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ThermographyValidator extends BaseValidator
- [ ] Delta-T classified into severity categories
- [ ] Critical hotspots produce CRITICAL findings
- [ ] NETA MTS Table 100.18 referenced
</verification>

<success_criteria>
- All tasks completed
- VALD-03 requirements addressed
- Severity escalates appropriately with delta-T
</success_criteria>

<output>
After completion, create `.planning/phases/03-validation-engine/03-04-SUMMARY.md`
</output>
