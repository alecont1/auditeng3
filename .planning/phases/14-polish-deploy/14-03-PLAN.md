---
phase: 14-polish-deploy
plan: 03
type: execute
wave: 2
depends_on: ["14-01", "14-02"]
files_modified:
  - web/vite.config.ts
  - web/vercel.json
  - web/.env.example
  - app/main.py
autonomous: false

user_setup:
  - service: vercel
    why: "Frontend deployment platform"
    env_vars:
      - name: VITE_API_URL
        source: "Your backend API URL (e.g., https://auditeng-api.railway.app)"
    account_setup:
      - url: "https://vercel.com/signup"
        skip_if: "Already have Vercel account"
    local_dev:
      - "vercel login"

must_haves:
  truths:
    - "Production build succeeds with optimized output"
    - "Frontend can connect to backend API in production"
    - "CORS allows requests from frontend domain"
  artifacts:
    - path: "web/vercel.json"
      provides: "Vercel deployment configuration"
      contains: "rewrites"
    - path: "web/.env.example"
      provides: "Environment variables documentation"
      contains: "VITE_API_URL"
  key_links:
    - from: "frontend (Vercel)"
      to: "backend API"
      via: "VITE_API_URL environment variable"
---

<objective>
Configure production build and deploy frontend to Vercel with proper API connectivity.

Purpose: Ship the v2.0 Web Dashboard to production.
Output: Live, working frontend deployed to Vercel with backend connectivity.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
@./.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@web/vite.config.ts
@web/package.json
@app/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure production build and environment</name>
  <files>web/vite.config.ts, web/.env.example, web/src/lib/api.ts</files>
  <action>
    1. Update vite.config.ts for production:
       - Remove proxy config for production (only use in dev)
       - Add build optimization settings if not present

    2. Create .env.example with:
       ```
       # API URL for production (required)
       VITE_API_URL=https://your-api-domain.com
       ```

    3. Update API client (src/lib/api.ts or services/analysis.ts):
       - Use import.meta.env.VITE_API_URL as base URL in production
       - Keep proxy behavior for development (when VITE_API_URL not set)

       Example:
       ```ts
       const baseURL = import.meta.env.VITE_API_URL || ''
       ```

       This allows:
       - Dev: Empty baseURL uses Vite proxy (/api -> localhost:8000)
       - Prod: VITE_API_URL points to real backend

    4. Test build:
       - Run `npm run build` to verify production build succeeds
       - Check dist/ folder size (should be under 500KB gzipped)
  </action>
  <verify>Run `npm run build` in web/ - succeeds, dist/ folder created</verify>
  <done>Production build configured with environment variable support</done>
</task>

<task type="auto">
  <name>Task 2: Create Vercel configuration</name>
  <files>web/vercel.json</files>
  <action>
    Create vercel.json for SPA routing:

    ```json
    {
      "rewrites": [
        { "source": "/(.*)", "destination": "/index.html" }
      ],
      "headers": [
        {
          "source": "/assets/(.*)",
          "headers": [
            { "key": "Cache-Control", "value": "public, max-age=31536000, immutable" }
          ]
        }
      ]
    }
    ```

    This ensures:
    - All routes serve index.html (React Router handles routing)
    - Static assets are cached for 1 year (Vite adds hashes to filenames)
  </action>
  <verify>File exists with correct structure</verify>
  <done>vercel.json created with SPA rewrites</done>
</task>

<task type="auto">
  <name>Task 3: Configure CORS on backend</name>
  <files>app/main.py</files>
  <action>
    Update FastAPI CORS middleware to allow frontend domain:

    1. Read current CORS config in app/main.py
    2. Update allowed_origins to include:
       - "http://localhost:3000" (dev)
       - "https://*.vercel.app" (Vercel preview deployments)
       - Production domain when known (can be added via env var)

    Use environment variable for flexibility:
    ```python
    import os

    # CORS origins
    cors_origins = [
        "http://localhost:3000",
        "http://localhost:5173",
    ]

    # Add production frontend URL if set
    frontend_url = os.getenv("FRONTEND_URL")
    if frontend_url:
        cors_origins.append(frontend_url)

    # Allow all Vercel preview deployments
    cors_origins.append("https://*.vercel.app")
    ```

    Note: For wildcard patterns, you may need to use CORSMiddleware with allow_origin_regex instead.
  </action>
  <verify>CORS config updated in app/main.py</verify>
  <done>Backend allows requests from frontend domains</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Production build configuration, Vercel config, and CORS setup</what-built>
  <how-to-verify>
    1. Deploy frontend to Vercel:
       - Run: cd web && vercel
       - Follow prompts (link to existing project or create new)
       - Set VITE_API_URL environment variable in Vercel dashboard

    2. Test production deployment:
       - Visit the Vercel deployment URL
       - Try logging in (should connect to backend API)
       - If CORS error: verify backend CORS config and redeploy
       - Upload a test document
       - View analysis details

    3. Verify functionality:
       - Login works
       - Dashboard shows analyses
       - Can view analysis details
       - Can approve/reject (if you have pending analyses)
       - PDF download works
  </how-to-verify>
  <resume-signal>Type "approved" with the production URL, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds in web/
- [ ] vercel.json exists with SPA rewrites
- [ ] .env.example documents VITE_API_URL
- [ ] Backend CORS allows frontend domain
- [ ] Human verified deployment works
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Frontend deployed to Vercel
- Can login and use full application in production
</success_criteria>

<output>
After completion, create `.planning/phases/14-polish-deploy/14-03-SUMMARY.md`
</output>
